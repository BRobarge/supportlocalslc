<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Local SLC - Sandy</title>
    <link href="/shared/output.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .category-pills::-webkit-scrollbar {
            height: 8px;
        }

        .category-pills::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        .category-pills::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }

        .category-pills::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
         /* Horizontal scroller: hide scrollbar until hover */
         /* (keep your tags-scroll rules) */
        .tags-scroll{
            overflow-x:auto;
            white-space:nowrap;
            -webkit-overflow-scrolling:touch;
            scrollbar-width:none;
            padding-bottom: 4px;            /* gives the chips a little breathing room */
        }
        .tags-scroll:hover{ scrollbar-width:thin; }
        .tags-scroll::-webkit-scrollbar{ height:0 }
        .tags-scroll:hover::-webkit-scrollbar{ height:6px }
        .tags-scroll::-webkit-scrollbar-thumb{
            background:rgba(15,23,42,.35);
            border-radius:9999px;
        }
        .tags-scroll::-webkit-scrollbar-track{ background:transparent }

        /* Chip: navy pill with bright yellow text, extra padding & spacing */
        .tag-chip{
            background:#0b4cef;              /* deep navy */
            color:#ffffff;                   /* yellow-300 (lighter “gold”) */
            border:1px solid rgba(253,224,71,.35);
            border-radius:9999px;
            padding:4px 12px;                /* ⬅ more internal padding */
            font-size:12px;
            line-height:1.1;
            font-weight:600;
            display:inline-flex;
            align-items:center;
            gap:.25rem;
            margin-right:8px;                /* ⬅ spacing between chips */
        }
        .tag-chip:last-child{ margin-right:0; }
        .tag-chip:hover{ background:#1e293b; }  /* slightly lighter navy on hover */
    </style>
</head>

<body class="bg-gray-100">

    <!-- Header / Navigation -->
    <header class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-6 py-3">
            <div class="flex justify-between items-center">
                <a href="/" class="flex-shrink-0">
                    <img class="h-12 w-auto"
                        src="https://kozlfywdsqjndcsibgtw.supabase.co/storage/v1/object/public/business-logos/Site%20Assets/Top%20Logo.png"
                        alt="SupportLocalSLC Logo">
                </a>
                <nav id="desktop-nav" class="hidden lg:flex items-center space-x-8">
                    <div class="relative dropdown">
                        <a href="#" class="dropdown-toggle text-gray-600 hover:text-blue-600 font-semibold"
                            data-toggle="dropdown">Directory <i class="fas fa-chevron-down text-xs ml-1"></i></a>
                        <div class="dropdown-menu hidden absolute mt-2 w-48 bg-white rounded-lg shadow-xl py-2">
                            <a href="/sandy/index.html" class="block px-4 py-2 text-gray-700 hover:bg-blue-50">Sandy</a>
                            <a href="#" class="block px-4 py-2 text-gray-400 cursor-not-allowed">Draper (Soon )</a>
                        </div>
                    </div>
                    <div class="relative dropdown">
                        <a href="#" class="dropdown-toggle text-gray-600 hover:text-blue-600 font-semibold"
                            data-toggle="dropdown">Offers <i class="fas fa-chevron-down text-xs ml-1"></i></a>
                        <div class="dropdown-menu hidden absolute mt-2 w-48 bg-white rounded-lg shadow-xl py-2">
                            <a href="/sandy/index.html?filter=offers"
                                class="block px-4 py-2 text-gray-700 hover:bg-blue-50">Sandy Offers</a>
                            <a href="#" class="block px-4 py-2 text-gray-400 cursor-not-allowed">Draper Offers
                                (Soon)</a>
                        </div>
                    </div>
                    <a href="#" class="text-gray-600 hover:text-blue-600 font-semibold">For Business Owners</a>
                </nav>
                <div class="hidden lg:block">
                    <a id="auth-link" href="/login.html"
                        class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Login</a>
                </div>
                <div class="lg:hidden">
                    <button id="mobile-menu-btn" class="text-gray-600 hover:text-gray-800 focus:outline-none"><i
                            class="fas fa-bars text-2xl"></i></button>
                </div>
            </div>
            <nav id="mobile-menu" class="lg:hidden hidden mt-4">
                <div class="dropdown">
                    <a href="#" class="dropdown-toggle block py-2 text-gray-700 font-semibold"
                        data-toggle="dropdown">Directory <i class="fas fa-chevron-down text-xs ml-1"></i></a>
                    <div class="dropdown-menu hidden pl-4">
                        <a href="/sandy/index.html" class="block py-2 text-gray-600">Sandy</a>
                        <a href="#" class="block py-2 text-gray-400 cursor-not-allowed">Draper (Soon)</a>
                    </div>
                </div>
                <div class="dropdown">
                    <a href="#" class="dropdown-toggle block py-2 text-gray-700 font-semibold"
                        data-toggle="dropdown">Offers <i class="fas fa-chevron-down text-xs ml-1"></i></a>
                    <div class="dropdown-menu hidden pl-4">
                        <a href="/sandy/index.html?filter=offers" class="block py-2 text-gray-600">Sandy Offers</a>
                        <a href="#" class="block py-2 text-gray-400 cursor-not-allowed">Draper Offers (Soon)</a>
                    </div>
                </div>
                <a href="#" class="block py-2 text-gray-700 font-semibold">For Business Owners</a>
                <hr class="my-2">
                <a id="mobile-auth-link" href="/login.html" class="block py-2 text-gray-700 font-semibold">Login</a>
            </nav>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">Sandy Directory</h1>
            <p class="text-lg text-gray-600 mt-2">Discover the best local businesses in Sandy.</p>
        </div>

        <div class="bg-white p-4 rounded-lg shadow-md mb-8 sticky top-[76px] z-30">
            <div class="relative mb-4">
                <input type="search" id="search-input" placeholder="Search by business name, category, or tag..."
                    class="w-full p-3 pl-10 border border-gray-300 rounded-lg">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>
            <div id="category-pills-container" class="category-pills flex items-center space-x-3 overflow-x-auto pb-3">
                <p class="text-gray-500">Loading categories...</p>
            </div>
        </div>

        <div id="business-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <p class="text-gray-500 col-span-full">Loading businesses...</p>
        </div>
    </main>

    <footer class="bg-gray-800 text-gray-400 mt-16">
        <div class="container mx-auto px-6 py-12">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div class="md:col-span-2">
                    <a href="/" class="flex items-center space-x-2">
                        <img class="h-10 w-auto"
                            src="https://kozlfywdsqjndcsibgtw.supabase.co/storage/v1/object/public/business-logos/Site%20Assets/Top%20Logo.png"
                            alt="SupportLocalSLC Logo">
                        <span class="text-white font-bold text-xl">SupportLocalSLC</span>
                    </a>
                    <p class="mt-4 text-sm">Your guide to the best local spots in Salt Lake County. Discover stories,
                        support dreams.</p>
                </div>
                <div>
                    <h3 class="text-white font-semibold tracking-wider uppercase">Navigate</h3>
                    <ul class="mt-4 space-y-2 text-sm">
                        <li><a href="/" class="hover:text-white">Home</a></li>
                        <li><a href="/sandy/index.html" class="hover:text-white">Directory</a></li>
                        <li><a href="#" class="hover:text-white">For Business Owners</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-white font-semibold tracking-wider uppercase">Legal</h3>
                    <ul class="mt-4 space-y-2 text-sm">
                        <li><a href="/terms.html" class="hover:text-white">Terms of Service</a></li>
                        <li><a href="/privacy.html" class="hover:text-white">Privacy Policy</a></li>
                    </ul>
                    <h3 class="text-white font-semibold tracking-wider uppercase mt-6">Connect</h3>
                    <div class="mt-4 flex space-x-4">
                        <a href="#" class="hover:text-white"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="hover:text-white"><i class="fab fa-instagram"></i></a>
                    </div>
                </div>
            </div>
            <div class="mt-8 border-t border-gray-700 pt-6 text-center text-sm">
                <p>&copy; 2025 SupportLocalSLC. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

    <script type="module">
        const supabaseUrl = 'https://kozlfywdsqjndcsibgtw.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtvemxmeXdkc3FqbmRjc2liZ3R3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyNTk0NzEsImV4cCI6MjA2NzgzNTQ3MX0.Xb0nRQIVhpW_7uBcwfIuvGZmyPMGzJq6k-6fdgfF3kw';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

        let allBusinesses = [];
        let mainCategories = [];

        // In /public/sandy/index.html
            document.addEventListener('DOMContentLoaded', async () => {
                updateNavAuth();

                const [businessesRes, allCategoriesRes] = await Promise.all([
                    supabaseClient
                        .from('businesses')
                        .select(`
                *,
                business_categories ( categories ( id, name, parent_id ) ),
                business_tags ( tags ( id, name ) )
            `)
                        .eq('territory', 'sandy')
                        .eq('claim_status', 'approved'),
                    supabaseClient
                        .from('categories')
                        .select('id, name, parent_id')
                ]);

                if (businessesRes.error || allCategoriesRes.error) {
                    console.error("Error fetching data:", businessesRes.error || allCategoriesRes.error);
                    document.getElementById('business-grid').innerHTML = '<p class="text-red-500 col-span-full text-center">Error loading data. Please try again.</p>';
                    return;
                }

                const allCategoriesMap = new Map(allCategoriesRes.data.map(c => [c.id, c]));

                allBusinesses = businessesRes.data.map(biz => {
                    const processedCategories = biz.business_categories.map(bc => {
                        const category = bc.categories;
                        let mainParentId = category.parent_id;
                        let current = category;
                        while (current && current.parent_id) {
                            mainParentId = current.parent_id;
                            current = allCategoriesMap.get(current.parent_id);
                        }
                        return { ...category, mainParentId: mainParentId || category.id };
                    });

                    return {
                        ...biz,
                        categories: processedCategories,
                        tags: biz.business_tags.map(bt => bt.tags)
                    };
                });

                mainCategories = allCategoriesRes.data.filter(c => c.parent_id === null);

                renderCategoryPills();
                renderBusinessGrid();

                document.getElementById('search-input').addEventListener('input', renderBusinessGrid);
                document.getElementById('category-pills-container').addEventListener('click', handlePillClick);
            });



        function renderCategoryPills() {
            const container = document.getElementById('category-pills-container');
            const pillsHtml = mainCategories.map(cat =>
                `<button class="category-pill flex-shrink-0 px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-200 rounded-full hover:bg-blue-500 hover:text-white" data-category-id="${cat.id}">
                    ${cat.name}
                </button>`
            ).join('');
            container.innerHTML = `<button class="category-pill active flex-shrink-0 px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-full" data-category-id="all">All</button>` + pillsHtml;
        }

                function escapeHtml(str) {
                    return String(str ?? '')
                        .replace(/&/g, '&amp;').replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                }

                // REPLACE your whole renderBusinessGrid with this
                function renderBusinessGrid() {
                    const grid = document.getElementById('business-grid');
                    const searchTerm = (document.getElementById('search-input').value || '').toLowerCase();
                    const activePill = document.querySelector('.category-pill.active');
                    // ✨ keep ids as strings (UUID-safe)
                    const activeCategoryId = activePill
                        ? (activePill.dataset.categoryId === 'all' ? 'all' : activePill.dataset.categoryId)
                        : 'all';

                    const filtered = allBusinesses.filter(biz => {
                        const searchCorpus = [
                            biz.name || '',
                            biz.tagline || '',
                            ...(biz.categories || []).map(c => c.name || ''),
                            ...(biz.tags || []).map(t => t.name || '')
                        ].join(' ').toLowerCase();

                        const matchesSearch = !searchTerm || searchCorpus.includes(searchTerm);
                        const matchesCategory = activeCategoryId === 'all'
                            || (biz.categories || []).some(cat => String(cat.mainParentId) === String(activeCategoryId));

                        return matchesSearch && matchesCategory;
                    });

                    if (filtered.length === 0) {
                        grid.innerHTML = '<p class="text-gray-500 col-span-full text-center">No businesses found matching your criteria.</p>';
                        return;
                    }

                    // show up to 3 chips, then "+N more"
                    const renderTagChips = (tags = []) => {
                        if (!tags.length) return '';
                        const shown = tags.slice(0, 3);
                        const more = tags.length - shown.length;

                        const chips = shown.map(tag => `
                                                    <span class="inline-block bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">
                                                    ${escapeHtml(tag.name)}
                                                    </span>
                                                `).join('');

                        const moreChip = more > 0
                            ? `<span class="inline-block bg-gray-100 text-gray-700 text-xs font-medium px-2.5 py-0.5 rounded-full"
                                title="${escapeHtml(tags.slice(3).map(t => t.name).join(', '))}">+${more} more</span>`
                            : '';

                        return chips + moreChip;
                    };


                    grid.innerHTML = filtered.map(biz => {
                       // build chips (ALL tags, no +N)
                        const tagsHtml = (biz.tags || [])
                            .map(t => `<span class="tag-chip">${escapeHtml(t.name)}</span>`)
                            .join('');

                        // ...inside the card template:
                        return `
                            <a href="business.html?id=${biz.id}" class="flex flex-col bg-white rounded-lg shadow-md overflow-hidden group border border-gray-200 hover:shadow-xl hover:border-blue-500 transition-all duration-300">
                                <div class="h-40 bg-gray-50 flex items-center justify-center overflow-hidden">
                                <img src="${biz.logo_url || 'https://placehold.co/400x300/EEE/31343C?text=Logo'}"
                                    alt="${escapeHtml(biz.name)} Logo"
                                    class="w-full h-full object-contain p-2 group-hover:scale-105 transition-transform duration-300">
                                </div>
                                <div class="p-4 flex flex-col flex-grow">
                                <h3 class="font-bold text-lg truncate text-gray-800">${escapeHtml(biz.name)}</h3>
                                <p class="text-sm text-gray-600 truncate flex-grow">${escapeHtml(biz.tagline || 'Local Sandy Business')}</p>

                                <!-- TAGS: scroll on hover, gradient fade at the right edge -->
                                <div class="mt-2 pt-2 border-t border-gray-100">
                                    <div class="relative group">
                                    <div class="tags-scroll pr-8">${tagsHtml}</div>
                                    <div class="pointer-events-none absolute right-0 top-0 h-7 w-8
                                                bg-gradient-to-l from-white to-transparent
                                                opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                    </div>
                                </div>
                                </div>
                            </a>
                            `;

                    }).join('');

                    function enableTagWheelScroll() {
                        document.querySelectorAll('.tags-scroll').forEach(scroller => {
                            scroller.addEventListener('wheel', (e) => {
                                if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) {
                                    scroller.scrollLeft += e.deltaY;
                                    e.preventDefault();
                                }
                            }, { passive: false });
                        });
                    }

                    enableTagWheelScroll();

                }





        function handlePillClick(e) {
            if (e.target.classList.contains('category-pill')) {
                document.querySelectorAll('.category-pill').forEach(pill => {
                    pill.classList.remove('active', 'bg-blue-600', 'text-white');
                    pill.classList.add('bg-gray-200', 'text-gray-700');
                });
                e.target.classList.add('active', 'bg-blue-600', 'text-white');
                e.target.classList.remove('bg-gray-200', 'text-gray-700');
                renderBusinessGrid();
            }
        }

        function updateNavAuth() {
            const authLink = document.getElementById('auth-link');
            const mobileAuthLink = document.getElementById('mobile-auth-link');
            const isLoggedIn = sessionStorage.getItem('supabase_session');

            if (isLoggedIn) {
                authLink.href = '/dashboard.html'; authLink.textContent = 'Dashboard';
                mobileAuthLink.href = '/dashboard.html'; mobileAuthLink.textContent = 'Dashboard';
            } else {
                authLink.href = '/login.html'; authLink.textContent = 'Login';
                mobileAuthLink.href = '/login.html'; mobileAuthLink.textContent = 'Login';
            }

            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenuBtn.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));

            document.addEventListener('click', (e) => {
                const isDropdownToggle = e.target.matches('[data-toggle="dropdown"]');
                if (!isDropdownToggle && e.target.closest('.dropdown') === null) {
                    document.querySelectorAll('.dropdown-menu').forEach(menu => menu.classList.add('hidden'));
                    return;
                }
                if (isDropdownToggle) {
                    e.preventDefault();
                    const dropdownMenu = e.target.nextElementSibling;
                    dropdownMenu.classList.toggle('hidden');
                }
            });
        }
    </script>
</body>

</html>