<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Local SLC - Sandy</title>
    <link href="/shared/output.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/shared/supabase-init.js"></script>
    <script src="/shared/header-nav.js"></script>
    <script defer src="/shared/include.js"></script>
    <script type="module" src="/shared/auth-nav.js"></script>
    

   
    <style>
        .category-pills::-webkit-scrollbar {
            height: 8px;
        }

        .category-pills::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        .category-pills::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }

        .category-pills::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
         /* Horizontal scroller: hide scrollbar until hover */
         /* (keep your tags-scroll rules) */
        .tags-scroll{
            overflow-x:auto;
            white-space:nowrap;
            -webkit-overflow-scrolling:touch;
            scrollbar-width:none;
            padding-bottom: 4px;            /* gives the chips a little breathing room */
        }
        .tags-scroll:hover{ scrollbar-width:thin; }
        .tags-scroll::-webkit-scrollbar{ height:0 }
        .tags-scroll:hover::-webkit-scrollbar{ height:6px }
        .tags-scroll::-webkit-scrollbar-thumb{
            background:rgba(15,23,42,.35);
            border-radius:9999px;
        }
        .tags-scroll::-webkit-scrollbar-track{ background:transparent }

        /* Chip: navy pill with bright yellow text, extra padding & spacing */
        .tag-chip{
            background:#0b4cef;              /* deep navy */
            color:#ffffff;                   /* yellow-300 (lighter “gold”) */
            border:1px solid rgba(253,224,71,.35);
            border-radius:9999px;
            padding:4px 12px;                /* ⬅ more internal padding */
            font-size:12px;
            line-height:1.1;
            font-weight:600;
            display:inline-flex;
            align-items:center;
            gap:.25rem;
            margin-right:8px;                /* ⬅ spacing between chips */
        }
        .tag-chip:last-child{ margin-right:0; }
        .tag-chip:hover{ background:#1e293b; }  /* slightly lighter navy on hover */
    </style>
</head>

<body class="bg-gray-100">

    <!-- Header / Navigation -->
    <header class="bg-white shadow-md sticky top-0 z-40">
        <div data-include="header"></div>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">Sandy Directory</h1>
            <p class="text-lg text-gray-600 mt-2">Discover the best local businesses in Sandy.</p>
        </div>

        <div class="container mx-auto px-4">
        
            <div class="lg:hidden mb-4">
                <button id="mobile-filter-btn"
                    class="w-full flex items-center justify-center py-3 px-4 bg-blue-600 text-white font-bold rounded-lg shadow-md">
                    <i class="fas fa-filter mr-2"></i>
                    Filter Businesses
                </button>
            </div>
        
            <div class="grid grid-cols-1 lg:grid-cols-4 lg:gap-8">
        
                <aside id="desktop-filter-panel"
                    class="hidden lg:block lg:col-span-1 bg-white p-6 rounded-lg shadow-md self-start">
                    <h2 class="text-xl font-bold mb-4">Filter Results</h2>
                    <div id="filter-panel-container" class="space-y-6">
                        <p class="text-gray-500">Loading filters...</p>
                    </div>
                </aside>
        
                <div class="lg:col-span-3">
                    <div class="relative mb-6">
                        <input type="search" id="search-input" placeholder="Search by business name, category, or tag..."
                            class="w-full p-3 pl-10 border border-gray-300 rounded-lg">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <div id="active-chips" class="mb-4 hidden"></div>
                    
                    <div id="business-grid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
        
                    <div id="business-grid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
                        <p class="text-gray-500 col-span-full">Loading businesses...</p>
                    </div>
                </div>
        
            </div>
        </div>
        
        <div id="mobile-filter-drawer" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
            <div class="absolute bottom-0 left-0 w-full bg-white rounded-t-2xl shadow-2xl max-h-[80vh] flex flex-col">
                <div class="flex items-center justify-between p-4 border-b">
                    <h2 class="text-xl font-bold">Filter Results</h2>
                    <button id="close-drawer-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                </div>
                <div id="mobile-filter-container" class="overflow-y-auto p-6 space-y-6">
                    <p class="text-gray-500">Loading filters...</p>
                </div>
                <div class="p-4 border-t bg-white sticky bottom-0">
                    <button id="apply-filters-btn" class="w-full py-3 bg-blue-600 text-white font-bold rounded-lg">Show
                        Results</button>
                </div>
            </div>
        </div>

        
    </main>

    <footer class="bg-gray-800 text-gray-400">
        <div data-include="footer"></div>
    </footer>

    <script type="module">
        const supabaseClient = window.supabaseClient;
        let allBusinesses = [];
        let allCategories = [];
        let allTags = new Map();

        // --- MAIN ENTRY POINT ---
        document.addEventListener('DOMContentLoaded', async () => {
                // This new query now joins with the profiles table to get the membership_level
                const [businessesRes, categoriesRes, tagsRes] = await Promise.all([
                    supabaseClient.from('businesses').select(`
            *, 
            profiles (membership_level), 
            offers(*), 
            business_categories(categories(id, name, parent_id)), 
            business_tags(tags(id, name))
        `).eq('territory', 'sandy').eq('claim_status', 'approved'),
                    supabaseClient.from('categories').select('id, name, parent_id').order('name'),
                    supabaseClient.from('tags').select('id, name').order('name')
                ]);

                if (businessesRes.error || categoriesRes.error || tagsRes.error) {
                    console.error("Error fetching data:", businessesRes.error || categoriesRes.error || tagsRes.error);
                    document.getElementById('business-grid').innerHTML = '<p class="text-red-500 col-span-full text-center">Error loading data. Please try again.</p>';
                    return;
                }

                allCategories = categoriesRes.data;
                tagsRes.data.forEach(tag => allTags.set(tag.id, tag.name));
                allBusinesses = processBusinessData(businessesRes.data);

                renderFilterPanels();
                renderActiveChips();
                applyOffersParam(); 
                renderBusinessGrid();
                setupEventListeners();
            });

        // --- DATA PROCESSING ---
        function processBusinessData(businesses) {
            const allCategoriesMap = new Map(allCategories.map(c => [c.id, c]));
            return businesses.map(biz => {
                const categories = biz.business_categories.map(bc => bc.categories);
                const tags = biz.business_tags.map(bt => bt.tags);
                // Add a simple flag for offers to make filtering easier
                const has_offers = biz.offers && biz.offers.length > 0;
                return { ...biz, categories, tags, has_offers };
            });
        }

        // --- UI RENDERING ---
        function renderFilterPanels() {
            // --- NEW: Define Tag Groups ---
            // We can make this dynamic from the database later, but for now, we'll manually group them.
            const cuisineTags = new Set(['Mexican', 'Italian', 'Pizza', 'Bakery', 'Coffee', 'Tacos']); // Add more cuisine-related tags here

            let dealsHtml = `
                <label class="flex items-center text-gray-600 hover:text-black font-semibold cursor-pointer">
                    <input type="checkbox" id="filter-offers" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 filter-checkbox" data-filter-type="offer">
                    <span class="ml-2">Active Offers</span>
                </label>
            `;

            const mainCategories = allCategories.filter(c => c.parent_id === null);
            let categoryHtml = '<div class="space-y-2">';
            mainCategories.forEach(mainCat => {
                categoryHtml += `<div class="font-bold text-gray-800 pt-2">${mainCat.name}</div><div class="pl-4 space-y-1">`;
                const subCats = allCategories.filter(sc => sc.parent_id === mainCat.id);
                subCats.forEach(subCat => {
                    categoryHtml += `
                        <label class="flex items-center text-gray-600 hover:text-black cursor-pointer">
                            <input type="checkbox" class="filter-checkbox" data-filter-type="category" value="${subCat.id}">
                            <span class="ml-2">${subCat.name}</span>
                        </label>`;
                });
                categoryHtml += `</div>`;
            });
            categoryHtml += '</div>';

            let cuisineTagHtml = `<div class="space-y-1">`;
            let featureTagHtml = `<div class="space-y-1">`;
            Array.from(allTags.entries()).forEach(([id, name]) => {
                const tagCheckboxHtml = `
                    <label class="flex items-center text-gray-600 hover:text-black cursor-pointer">
                        <input type="checkbox" class="filter-checkbox" data-filter-type="tag" value="${id}">
                        <span class="ml-2">${name}</span>
                    </label>`;
                if (cuisineTags.has(name)) {
                    cuisineTagHtml += tagCheckboxHtml;
                } else {
                    featureTagHtml += tagCheckboxHtml;
                }
            });
            cuisineTagHtml += '</div>';
            featureTagHtml += '</div>';

            const fullFilterHtml = `
                <!-- TOP clear button -->
                <div class="sticky top-0 z-10 bg-white pb-3 mb-3 border-b">
                    <button type="button"
                            class="clear-filters-btn w-full inline-flex items-center justify-center gap-2 px-4 py-2 rounded-md bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium shadow-sm">
                    <i class="fas fa-broom text-sm"></i>
                    Clear All Filters
                    </button>
                </div>

                <div>
                    <h3 class="text-lg font-semibold border-b pb-2 mb-3">Deals</h3>
                    ${dealsHtml}
                </div>
                <div>
                    <h3 class="text-lg font-semibold border-b pb-2 mb-3">Categories</h3>
                    ${categoryHtml}
                </div>
                <div>
                    <h3 class="text-lg font-semibold border-b pb-2 mb-3">Cuisine & Type</h3>
                    ${cuisineTagHtml}
                </div>
                <div>
                    <h3 class="text-lg font-semibold border-b pb-2 mb-3">Features & Amenities</h3>
                    ${featureTagHtml}
                </div>

                <!-- BOTTOM clear button -->
                <div class="pt-2">
                    <button type="button"
                            class="clear-filters-btn w-full inline-flex items-center justify-center gap-2 px-4 py-2 rounded-md bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium shadow-sm">
                    <i class="fas fa-broom text-sm"></i>
                    Clear All Filters
                    </button>
                </div>
                `;


            document.getElementById('filter-panel-container').innerHTML = fullFilterHtml;
            document.getElementById('mobile-filter-container').innerHTML = fullFilterHtml;
        }

        function applyOffersParam() {
                const params = new URLSearchParams(location.search);
                // support both styles: ?offers=1 and ?filter=offers
                const wantsOffers = params.get('offers') === '1' || params.get('filter') === 'offers';
                if (!wantsOffers) return;

                // Check the "Active Offers" box in BOTH panels
                ['filter-panel-container', 'mobile-filter-container'].forEach(id => {
                    const container = document.getElementById(id);
                    const cb = container?.querySelector('#filter-offers'); // this id already exists in your Deals section
                    if (cb && !cb.checked) {
                        cb.checked = true;
                        cb.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                });
                  // After applying from URL once, strip the param so refresh doesn't re-check it
            const url = new URL(window.location.href);
            url.searchParams.delete('offers');
            url.searchParams.delete('filter');
            const q = url.searchParams.toString();
            history.replaceState({}, '', url.pathname + (q ? `?${q}` : '') + url.hash);

            }

            function renderActiveChips() {
                    const chipHost = document.getElementById('active-chips');
                    if (!chipHost) return;

                    const isMobile = window.innerWidth < 1024;
                    const panel = isMobile
                        ? document.getElementById('mobile-filter-container')
                        : document.getElementById('filter-panel-container');

                    const chips = [];

                    // Search term
                    const searchInput = document.getElementById('search-input');
                    const searchTerm = (searchInput?.value || '').trim();
                    if (searchTerm) chips.push({ type: 'search', label: `Search: ${searchTerm}` });

                    // Offers
                    const offersOn = !!panel.querySelector('#filter-offers')?.checked;
                    if (offersOn) chips.push({ type: 'offer', label: 'Active Offers' });

                    // Categories
                    panel.querySelectorAll('.filter-checkbox[data-filter-type="category"]:checked')
                        .forEach(cb => {
                            const label = cb.nextElementSibling?.textContent?.trim() || 'Category';
                            chips.push({ type: 'category', value: cb.value, label });
                        });

                    // Tags
                    panel.querySelectorAll('.filter-checkbox[data-filter-type="tag"]:checked')
                        .forEach(cb => {
                            const label = cb.nextElementSibling?.textContent?.trim() || 'Tag';
                            chips.push({ type: 'tag', value: cb.value, label });
                        });

                    // Render
                    if (chips.length === 0) {
                        chipHost.innerHTML = '';
                        chipHost.classList.add('hidden');
                        return;
                    }

                    chipHost.classList.remove('hidden');
                    chipHost.innerHTML = `
    <div class="flex flex-wrap gap-2">
      ${chips.map(c => `
        <button type="button" class="tag-chip" data-chip-type="${c.type}" data-chip-value="${c.value || ''}">
          ${c.label}<span aria-hidden="true">&nbsp;×</span>
        </button>`).join('')}
    </div>
  `;

                    // Remove a single filter when a chip is clicked
                    chipHost.onclick = (e) => {
                        const chip = e.target.closest('.tag-chip');
                        if (!chip) return;

                        const type = chip.dataset.chipType;
                        const val = chip.dataset.chipValue;

                        if (type === 'search') {
                            if (searchInput) searchInput.value = '';
                        } else if (type === 'offer') {
                            ['filter-panel-container', 'mobile-filter-container'].forEach(id => {
                                const el = document.getElementById(id)?.querySelector('#filter-offers');
                                if (el) el.checked = false;
                            });
                        } else if (type === 'category' || type === 'tag') {
                            ['filter-panel-container', 'mobile-filter-container'].forEach(id => {
                                const sel = `.filter-checkbox[data-filter-type="${type}"][value="${val}"]`;
                                document.getElementById(id)?.querySelectorAll(sel).forEach(el => el.checked = false);
                            });
                        }

                        renderActiveChips();
                        renderBusinessGrid();
                    };
                }



        function renderBusinessGrid() {
                const grid = document.getElementById('business-grid');

                // --- FILTERING LOGIC (from your code) ---
                const isMobile = window.innerWidth < 1024;
                const activeFilterContainer = isMobile ? document.getElementById('mobile-filter-container') : document.getElementById('filter-panel-container');
                const searchTerm = document.getElementById('search-input').value.toLowerCase();
                const wantsOffers = activeFilterContainer.querySelector('#filter-offers')?.checked;
                const selectedCategoryIds = new Set(Array.from(activeFilterContainer.querySelectorAll('.filter-checkbox[data-filter-type="category"]:checked')).map(el => el.value));
                const selectedTagIds = new Set(Array.from(activeFilterContainer.querySelectorAll('.filter-checkbox[data-filter-type="tag"]:checked')).map(el => el.value));

                const filtered = allBusinesses.filter(biz => {
                    const searchCorpus = [biz.name || '', biz.tagline || '', ...biz.categories.map(c => c.name || ''), ...biz.tags.map(t => t.name || '')].join(' ').toLowerCase();
                    const matchesSearch = !searchTerm || searchCorpus.includes(searchTerm);
                    const matchesOffers = !wantsOffers || biz.has_offers;
                    const matchesCategory = selectedCategoryIds.size === 0 || biz.categories.some(cat => selectedCategoryIds.has(String(cat.id)));
                    const matchesTag = selectedTagIds.size === 0 || biz.tags.some(tag => selectedTagIds.has(String(tag.id)));
                    return matchesSearch && matchesOffers && matchesCategory && matchesTag;
                });

                // --- SORTING LOGIC ---
                const tierWeights = { pro: 3, essentials: 2, free: 1 };
                const normTier = (lvl) => (lvl || 'free').toString().trim().toLowerCase();

                filtered.sort((a, b) => {
                    const weightA = tierWeights[normTier(a.profiles?.membership_level)] || 0;
                    const weightB = tierWeights[normTier(b.profiles?.membership_level)] || 0;
                    if (weightA !== weightB) return weightB - weightA; // Pro > Essentials > free
                    return Math.random() - 0.5; // randomize within same tier
                });


                // --- GRID RENDERING ---
                if (filtered.length === 0) {
                    grid.innerHTML = '<p class="text-gray-500 col-span-full text-center">No businesses found matching your criteria.</p>';
                    return;
                }

                grid.innerHTML = filtered.map(biz => {
                    const level = (biz.profiles?.membership_level || 'free').toString().trim().toLowerCase();

                    // Subtle Sponsored Label (show for Pro + Essentials)
                    const sponsoredLabel = (level === 'pro' || level === 'essentials')
                        ? `<p class="text-xs font-semibold text-blue-800 uppercase tracking-wide">Sponsored Listing</p>`
                        : '';


                    // Limited Tags with "+N more"
                    const allBizTags = biz.tags || [];
                    const tagsToShow = allBizTags.slice(0, 3);
                    const remainingTagsCount = allBizTags.length - tagsToShow.length;
                    const tagsHtml = tagsToShow.map(t => `<span class="inline-block bg-gray-200 text-gray-700 text-xs font-medium px-2.5 py-1 rounded-full">${t.name}</span>`).join('');
                    const moreTagsHtml = remainingTagsCount > 0
                        ? `<span class="inline-block bg-gray-100 text-gray-600 text-xs font-medium px-2.5 py-1 rounded-full">+${remainingTagsCount} more</span>`
                        : '';

                    // Offer indicators
                    const offerRingClass = biz.has_offers ? 'ring-2 ring-offset-2 ring-yellow-400' : 'border-gray-200';
                    const offerIndicator = biz.has_offers ? '<div class="absolute top-2 right-2 bg-yellow-400 text-yellow-900 text-xs font-bold px-2 py-1 rounded-full z-10">OFFER</div>' : '';

                    // --- Final Card HTML (restoring the preferred "old look") ---
                    return `
            <a href="business.html?id=${biz.id}" class="relative flex flex-col bg-white rounded-lg shadow-md overflow-hidden group border hover:shadow-xl hover:border-blue-500 transition-all duration-300 ${offerRingClass}">
                ${offerIndicator}
                <div class="h-40 bg-gray-50 flex items-center justify-center overflow-hidden">
                    <img src="${biz.logo_url || 'https://placehold.co/400x300/EEE/31343C?text=Logo'}" alt="${biz.name} Logo" class="w-full h-full object-contain p-2 group-hover:scale-105 transition-transform duration-300">
                </div>
                <div class="p-4 flex flex-col flex-grow">
                    <h3 class="font-bold text-lg truncate text-gray-800">${biz.name}</h3>
                    ${sponsoredLabel}
                    <p class="text-sm text-gray-600 truncate mt-1 flex-grow">${biz.tagline || 'Local Sandy Business'}</p>
                    <div class="mt-3 pt-3 border-t border-gray-100">
                        <div class="flex flex-wrap items-center gap-2">
                            ${tagsHtml}
                            ${moreTagsHtml}
                        </div>
                    </div>
                </div>
            </a>
        `;
                }).join('');
            }

        // --- EVENT LISTENERS (No changes needed here) ---
        function setupEventListeners() {
            const drawer = document.getElementById('mobile-filter-drawer');
            document.getElementById('mobile-filter-btn').addEventListener('click', () => drawer.classList.remove('hidden'));
            document.getElementById('close-drawer-btn').addEventListener('click', () => drawer.classList.add('hidden'));
            document.getElementById('apply-filters-btn').addEventListener('click', () => {
                renderBusinessGrid();
                renderActiveChips(); // NEW
                drawer.classList.add('hidden');
            });

            document.getElementById('search-input').addEventListener('input', () => {
                renderBusinessGrid();
                renderActiveChips(); // NEW
            });

            document.getElementById('filter-panel-container').addEventListener('click', handleFilterChange);
            document.getElementById('mobile-filter-container').addEventListener('click', handleFilterChange);

            window.addEventListener('resize', renderActiveChips);

            
        }

         function handleFilterChange(event) {
                const target = event.target;

                // Clear buttons (top OR bottom) — support clicks on the button OR its icon
                if (target.id === 'clear-filters-btn' || (target.closest && target.closest('.clear-filters-btn'))) {
                    // 1) Uncheck ALL checkboxes in BOTH panels
                    document.querySelectorAll('.filter-checkbox').forEach(cb => (cb.checked = false));

                    // 2) Clear search
                    const search = document.getElementById('search-input');
                    if (search) search.value = '';

                    // 3) Remove any filter params so refresh starts clean
                    const url = new URL(window.location.href);
                    url.search = '';
                    history.replaceState({}, '', url.pathname + url.hash);

                    // 4) Re-render results + chips
                    renderBusinessGrid();
                    if (typeof renderActiveChips === 'function') renderActiveChips();

                    // 5) Close mobile drawer if open
                    document.getElementById('mobile-filter-drawer')?.classList?.add('hidden');

                    return; // done
                }

                // Normal filter clicks:
                // Desktop: update immediately; Mobile: user taps "Show Results"
                if (window.innerWidth >= 1024) {
                    renderBusinessGrid();
                    if (typeof renderActiveChips === 'function') renderActiveChips();
                }
            }


    </script>
</body>

</html>