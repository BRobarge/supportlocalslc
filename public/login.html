<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login / Sign Up — SupportLocalSLC</title>
    <link href="/shared/output.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/shared/supabase-init.js"></script>
    <script src="/shared/header-nav.js"></script>
    <script defer src="/shared/include.js"></script>
    <script type="module" src="/shared/auth-nav.js"></script>
   
</head>

<body class="bg-white font-sans text-slate-900">
    <!-- ============================================================= -->
    <!-- HEADER (matches new Index layout)                             -->
    <!-- ============================================================= -->
    <header class="bg-white shadow-md sticky top-0 z-40">
        <div data-include="header"></div>
    </header>

    <!-- ============================================================= -->
    <!-- MAIN AUTH CARD                                                -->
    <!-- ============================================================= -->
    <main class="container mx-auto px-6 py-10">
        <section class="max-w-xl mx-auto bg-white rounded-2xl shadow p-6 sm:p-8">
            <!-- Tabs -->
            <div class="flex rounded-xl bg-slate-100 p-1 mb-6" role="tablist" aria-label="Auth tabs">
                <button id="tab-login" role="tab" aria-selected="true" aria-controls="panel-login"
                    class="flex-1 rounded-lg py-2.5 text-sm font-semibold bg-white shadow">Login</button>
                <button id="tab-signup" role="tab" aria-selected="false" aria-controls="panel-signup"
                    class="flex-1 rounded-lg py-2.5 text-sm font-semibold text-slate-600">Create account</button>
            </div>

            <!-- Messages -->
            <div id="success-message"
                class="hidden mb-4 rounded-lg border border-green-200 bg-green-50 text-green-800 px-3 py-2 text-sm">
            </div>
            <div id="error-message"
                class="hidden mb-4 rounded-lg border border-red-200 bg-red-50 text-red-800 px-3 py-2 text-sm"></div>

            <!-- LOGIN PANEL -->
            <form id="panel-login" role="tabpanel" aria-labelledby="tab-login" class="space-y-4">
                <label class="block">
                    <span class="text-sm font-medium">Email</span>
                    <input id="login-email" type="email" autocomplete="email"
                        class="mt-1 w-full rounded-lg border border-slate-300 p-2.5 focus:outline-none focus:ring-2 focus:ring-blue-600"
                        required />
                </label>
                <label class="block">
                    <span class="text-sm font-medium">Password</span>
                    <div class="mt-1 relative">
                        <input id="login-password" type="password" autocomplete="current-password"
                            class="w-full rounded-lg border border-slate-300 p-2.5 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-600"
                            required />
                        <button type="button" id="login-toggle-pass"
                            class="absolute inset-y-0 right-0 px-3 text-slate-500" aria-label="Show password"><i
                                class="far fa-eye"></i></button>
                    </div>
                </label>
                <!-- Keep your preferred button color -->
                <button type="submit" class="w-full rounded-lg bg-blue-900 text-yellow-300 font-semibold py-2.5 hover:bg-blue-800">
                    Login
                </button>
                
                <!-- subtle divider -->
                <div class="mt-3 text-center text-sm text-slate-500">or</div>
                
                <!-- magic link button -->
                <button type="button" id="login-magic"
                    class="w-full mt-2 rounded-lg bg-blue-900 text-yellow-300 font-semibold py-2.5 hover:bg-blue-800">
                    Email me a magic link
                </button>
                
                <p class="mt-2 text-xs text-slate-500 text-center">
                    We’ll email you a one-time sign-in link.
                </p>

                <div class="flex items-center justify-between text-sm">
                    <button type="button" id="forgot" class="underline">Forgot password?</button>
                </div>
                <div class="pt-2">
                    <button type="button" id="login-google"
                        class="w-full rounded-lg border border-slate-300 py-2.5 text-sm font-semibold hover:bg-slate-50 flex items-center justify-center gap-2">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt=""
                            class="w-5 h-5" />
                        Continue with Google
                    </button>
                </div>
            </form>

            <!-- SIGNUP PANEL -->
            <form id="panel-signup" role="tabpanel" aria-labelledby="tab-signup" class="space-y-4 hidden">
                <p class="text-sm text-slate-600">All accounts start as <strong>Supporters</strong>. You can claim a
                    business later inside your dashboard.</p>
                <label class="block">
                    <span class="text-sm font-medium">Email</span>
                    <input id="signup-email" type="email" autocomplete="email"
                        class="mt-1 w-full rounded-lg border border-slate-300 p-2.5 focus:outline-none focus:ring-2 focus:ring-blue-600"
                        required />
                </label>
                <label class="block">
                    <span class="text-sm font-medium">Password</span>
                    <div class="mt-1 relative">
                        <input id="signup-password" type="password" autocomplete="new-password"
                            class="w-full rounded-lg border border-slate-300 p-2.5 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-600"
                            required />
                        <button type="button" id="signup-toggle-pass"
                            class="absolute inset-y-0 right-0 px-3 text-slate-500" aria-label="Show password"><i
                                class="far fa-eye"></i></button>
                    </div>
                </label>
                <button type="submit"
                    class="w-full rounded-lg bg-blue-900 text-yellow-300 font-semibold py-2.5 hover:bg-blue-800">Create
                    account</button>
                    <!-- subtle divider -->
                    <div class="mt-3 text-center text-sm text-slate-500">or</div>
                    
                    <!-- magic link button -->
                    <button type="button" id="signup-magic"
                        class="w-full mt-2 rounded-lg bg-blue-900 text-yellow-300 font-semibold py-2.5 hover:bg-blue-800">
                        Email me a magic link
                    </button>
                    
                    <p class="mt-2 text-xs text-slate-500 text-center">
                        No password needed. We’ll create your account after you click the link.
                    </p>
                <div class="pt-2">
                    <button type="button" id="signup-google"
                        class="w-full rounded-lg border border-slate-300 py-2.5 text-sm font-semibold hover:bg-slate-50 flex items-center justify-center gap-2">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt=""
                            class="w-5 h-5" />
                        Sign up with Google
                    </button>
                </div>
            </form>
        </section>
    </main>

    <!-- ============================================================= -->
    <!-- FOOTER (matches new Index layout)                             -->
    <!-- ============================================================= -->
    <footer class="bg-gray-800 text-gray-400">
        <div data-include="footer"></div>
    </footer>

    <!-- ============================================================= -->
    <!-- SCRIPT                                                         -->
    <!-- ============================================================= -->
    <script type="module">
    // ===== Supabase client =====
    const supabaseUrl = 'https://kozlfywdsqjndcsibgtw.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtvemxmeXdkc3FqbmRjc2liZ3R3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyNTk0NzEsImV4cCI6MjA2NzgzNTQ3MX0.Xb0nRQIVhpW_7uBcwfIuvGZmyPMGzJq6k-6fdgfF3kw';
    const sb = window.supabaseClient || supabase.createClient(supabaseUrl, supabaseAnonKey);
    window.supabaseClient = sb;

    // ===== Helpers =====
    const $ = (sel, root = document) => root.querySelector(sel);
    const successBox = $('#success-message');
    const errorBox = $('#error-message');
    const showSuccess = (m) => { successBox.textContent = m; successBox.classList.remove('hidden'); errorBox.classList.add('hidden'); }
    const showError = (m) => { errorBox.textContent = m; errorBox.classList.remove('hidden'); successBox.classList.add('hidden'); }
    const hideMsg = () => { successBox.classList.add('hidden'); errorBox.classList.add('hidden'); }

    // Tabs
    function setTab(which) {
        const isLogin = which === 'login';
        const tabLogin = $('#tab-login'), tabSignup = $('#tab-signup');
        const panelLogin = $('#panel-login'), panelSignup = $('#panel-signup');
        
        tabLogin.setAttribute('aria-selected', isLogin);
        tabSignup.setAttribute('aria-selected', !isLogin);
        tabLogin.classList.toggle('bg-white', isLogin);
        tabLogin.classList.toggle('text-slate-600', !isLogin);
        tabLogin.classList.toggle('shadow', isLogin);
        tabSignup.classList.toggle('bg-white', !isLogin);
        tabSignup.classList.toggle('text-slate-600', isLogin);
        tabSignup.classList.toggle('shadow', !isLogin);
        
        panelLogin.classList.toggle('hidden', !isLogin);
        panelSignup.classList.toggle('hidden', isLogin);
        hideMsg();
    }

    // ===== Click handling =====
    document.addEventListener('click', async (e) => {
        // Tabs
        if (e.target.closest('#tab-login')) { 
            e.preventDefault(); 
            setTab('login'); 
            return; 
        }
        if (e.target.closest('#tab-signup')) { 
            e.preventDefault(); 
            setTab('signup'); 
            return; 
        }

        // Password toggles
        if (e.target.closest('#login-toggle-pass')) { 
            const i = $('#login-password'); 
            i.type = i.type === 'password' ? 'text' : 'password'; 
            return; 
        }
        if (e.target.closest('#signup-toggle-pass')) { 
            const i = $('#signup-password'); 
            i.type = i.type === 'password' ? 'text' : 'password'; 
            return; 
        }

        // Forgot password
        if (e.target.closest('#forgot')) {
            e.preventDefault();
            const email = ($('#login-email')?.value || '').trim();
            if (!email) { showError('Enter your email above, then click again.'); return; }
            const redirectTo = `${window.location.origin}/reset.html`;
            const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo });
            if (error) { showError(error.message); return; }
            showSuccess('Password reset email sent. Check your inbox.');
            return;
        }

        // Google OAuth
        if (e.target.closest('#login-google, #signup-google')) {
            e.preventDefault();
            const redirectTo = window.location.origin + '/dashboard.html';
            const { error } = await sb.auth.signInWithOAuth({ 
                provider: 'google', 
                options: { redirectTo } 
            });
            if (error) showError(error.message);
            return;
        }

        // Magic links (both login and signup)
        if (e.target.closest('#login-magic, #signup-magic')) {
            e.preventDefault();
            hideMsg();
            
            const isLogin = e.target.closest('#login-magic');
            const emailInputId = isLogin ? 'login-email' : 'signup-email';
            const email = (document.getElementById(emailInputId)?.value || '').trim();
            
            if (!email) { 
                showError('Enter your email first.'); 
                return; 
            }

            const btn = e.target.closest('button');
            const prev = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Sending…';

            const redirectTo = window.location.origin + '/dashboard.html';
            const { error } = await sb.auth.signInWithOtp({
                email,
                options: { emailRedirectTo: redirectTo }
            });

            if (error) {
                if (error.status === 429 || /rate limit/i.test(error.message)) {
                    showError('We just sent you a link. Please wait 60s before requesting another.');
                    let s = 60;
                    const timer = setInterval(() => {
                        s--;
                        btn.textContent = `Wait ${s}s`;
                        if (s <= 0) {
                            clearInterval(timer);
                            btn.disabled = false;
                            btn.textContent = prev;
                            hideMsg();
                        }
                    }, 1000);
                    return;
                }
                btn.disabled = false;
                btn.textContent = prev;
                showError(error.message || 'Could not send magic link.');
                return;
            }

            btn.textContent = prev;
            showSuccess('Magic link sent. Check your inbox.');
            setTimeout(() => { btn.disabled = false; }, 3000);
            return;
        }
    });

    // ===== Form submits =====
    document.addEventListener('submit', async (e) => {
        const form = e.target;
        
        // Login form
        if (form && form.id === 'panel-login') {
            e.preventDefault(); 
            hideMsg();
            const email = ($('#login-email')?.value || '').trim();
            const password = $('#login-password')?.value || '';
            const { data, error } = await sb.auth.signInWithPassword({ email, password });
            if (error) { showError(error.message); return; }
            try { 
                await sb.from('profiles').upsert({ 
                    id: data.user.id, 
                    email, 
                    role: 'supporter' 
                }, { onConflict: 'id' }); 
            } catch { }
            window.location.href = '/dashboard.html';
            return;
        }
        
        // Signup form
        if (form && form.id === 'panel-signup') {
            e.preventDefault(); 
            hideMsg();
            const email = ($('#signup-email')?.value || '').trim();
            const password = $('#signup-password')?.value || '';
            const emailRedirectTo = `${window.location.origin}/login.html`;
            const { data, error } = await sb.auth.signUp({ 
                email, 
                password, 
                options: { 
                    data: { role: 'supporter' }, 
                    emailRedirectTo 
                } 
            });
            if (error) { showError(error.message); return; }
            try { 
                await sb.from('profiles').upsert({ 
                    id: data.user?.id, 
                    email, 
                    role: 'supporter' 
                }) 
            } catch { }
            setTab('login'); 
            showSuccess('Sign up successful. Confirm your email, then log in.');
            return;
        }
    });

    // ===== On load =====
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => setTab('login'), { once: true });
    } else {
        setTab('login');
    }

    // Bounce if already logged in
    (async () => {
        const { data: { session } } = await sb.auth.getSession();
        if (session) window.location.href = '/dashboard.html';
    })();
</script>

</body>

</html>
