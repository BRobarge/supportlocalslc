<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SupportLocalSLC</title>
    <link href="./output.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 font-sans">
    <header class="shadow-md">
        <div class="w-full h-40 md:h-48 lg:h-auto overflow-hidden">
            <img src="https://storage.googleapis.com/msgsndr/ZPvezSzdrR59azHbDrVt/media/687154c0f85f420c26bbfd37.jpeg" alt="Support Local SLC Banner" class="w-full h-full object-cover object-bottom lg:h-auto lg:object-contain">
        </div>
    </header>
    <nav class="w-full bg-blue-600 shadow-md flex justify-around items-center py-4">
        <a href="index.html" class="text-white hover:text-yellow-300 flex flex-col items-center">
            <i class="fas fa-home text-3xl"></i>
            <span class="text-base font-bold">Home</span>
        </a>
        <a id="auth-link" href="login.html" class="text-white hover:text-yellow-300 flex flex-col items-center">
            <i class="fas fa-sign-in-alt text-3xl"></i>
            <span class="text-base font-bold">Login</span>
        </a>
        <a href="dashboard.html" class="text-white hover:text-yellow-300 flex flex-col items-center">
            <i class="fas fa-user-cog text-3xl"></i>
            <span class="text-base font-bold">Dashboard</span>
        </a>
    </nav>
    <main class="container mx-auto p-4">
        <h2 class="text-xl font-semibold mb-4">Claim or Edit Your Business</h2>
        <div class="mb-4">
            <input id="claim-code" type="text" placeholder="Enter your claim code..." class="w-full p-2 border rounded">
            <button onclick="claimWithCode()" class="bg-green-500 text-white p-2 rounded w-full mt-2">Claim with Code</button>
        </div>
        <button onclick="toggleSearch()" class="bg-blue-500 text-white p-2 rounded w-full mb-4">Search for My Business</button>
        <div id="search-section" class="hidden">
            <input id="search-business" type="text" placeholder="Search business name..." class="w-full p-2 mb-2 border rounded">
            <div id="search-results" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>
        <div id="owned-businesses" class="mt-8">
            <h3 class="text-lg font-bold mb-2">Your Businesses</h3>
            <div id="owned-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>
        <div id="edit-form" class="hidden bg-white p-6 rounded shadow-md mt-4">
            <h3 class="text-lg font-bold mb-4">Edit Business</h3>
            <input type="hidden" id="edit-id">
            <input type="text" id="name" placeholder="Business Name" class="w-full p-2 mb-2 border rounded" required>
            <input type="text" id="tagline" placeholder="Tagline" class="w-full p-2 mb-2 border rounded">
            <textarea id="description" placeholder="Description" class="w-full p-2 mb-2 border rounded"></textarea>
            <input type="text" id="address" placeholder="Address (e.g., 123 Main St, Sandy, UT)" class="w-full p-2 mb-2 border rounded">
            <input type="url" id="website" placeholder="Website" class="w-full p-2 mb-2 border rounded">
            <input type="url" id="menu_url" placeholder="Menu URL" class="w-full p-2 mb-2 border rounded">
            <div class="mb-2">
                <label>Social Links:</label>
                <input type="url" id="facebook" placeholder="Facebook" class="w-full p-2 mb-1 border rounded">
                <input type="url" id="instagram" placeholder="Instagram" class="w-full p-2 mb-1 border rounded">
                <input type="url" id="twitter" placeholder="Twitter" class="w-full p-2 mb-1 border rounded">
            </div>
            <div class="mb-2">
                <label>Categories (select multiple):</label>
                <select id="categories" multiple class="w-full p-2 border rounded">
                    <!-- Filled in script -->
                </select>
            </div>
            <div class="mb-2">
                <label>Logo Upload:</label>
                <input type="file" id="logo-upload" accept="image/*" class="w-full">
            </div>
            <div class="mb-2">
                <label>Photos Upload (multiple):</label>
                <input type="file" id="photos-upload" accept="image/*" multiple class="w-full">
            </div>
            <button onclick="saveBusiness()" class="bg-blue-500 text-white p-2 rounded w-full">Save</button>
            <button onclick="cancelEdit()" class="bg-gray-500 text-white p-2 rounded w-full mt-2">Cancel</button>
        </div>
    </main>
    
    <script>
        const supabaseUrl = 'https://kozlfywdsqjndcsibgtw.supabase.co';
            const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtvemxmeXdkc3FqbmRjc2liZ3R3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyNTk0NzEsImV4cCI6MjA2NzgzNTQ3MX0.Xb0nRQIVhpW_7uBcwfIuvGZmyPMGzJq6k-6fdgfF3kw';
            const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

            let currentUser;
            let predefinedCategories = ['Restaurant', 'Retail', 'Service', 'Entertainment', 'Health', 'Education', 'Other'];

            // Hide edit form on load (prevents it showing by mistake)
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('edit-form').style.display = 'none';
            });

            // Dynamic nav swap (Login to Logout based on session)
            async function updateNavAuth() {
                const storedSession = sessionStorage.getItem('supabase_session');
                const authLink = document.getElementById('auth-link');
                if (!authLink) {
                    console.log('No auth link found');
                    return;
                }
                const iconElement = authLink.querySelector('svg, i');
                const textSpan = authLink.querySelector('span');
                console.log('Stored session:', storedSession ? 'Yes' : 'No'); // Debug
                if (storedSession) {
                    authLink.href = '#';
                    authLink.onclick = async function (e) {
                        e.preventDefault();
                        await supabaseClient.auth.signOut();
                        sessionStorage.removeItem('supabase_session');
                        console.log('Logged out');
                        window.location.href = 'login.html';
                    };
                    if (iconElement) iconElement.classList.replace('fa-sign-in-alt', 'fa-sign-out-alt');
                    if (textSpan) textSpan.textContent = 'Logout';
                    console.log('Swapped to Logout');
                } else {
                    authLink.href = 'login.html';
                    authLink.onclick = null;
                    if (iconElement) iconElement.classList.replace('fa-sign-out-alt', 'fa-sign-in-alt');
                    if (textSpan) textSpan.textContent = 'Login';
                    console.log('Swapped to Login');
                }
            }

            // Fill categories dropdown for edit form
            function populateCategoriesSelect() {
                const select = document.getElementById('categories');
                predefinedCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    select.appendChild(option);
                });
            }

            // Init dashboard (restore session, check auth, load stuff)
            async function initDashboard() {
                const storedSession = sessionStorage.getItem('supabase_session');
                if (storedSession) {
                    const session = JSON.parse(storedSession);
                    const { error } = await supabaseClient.auth.setSession(session);
                    if (error) console.error('Session set error:', error);
                }
                const { data, error: userError } = await supabaseClient.auth.getUser();
                if (userError || !data || !data.user) {
                    console.error('Auth error:', userError || 'No user data');
                    window.location.href = 'login.html';
                    return;
                }
                currentUser = data.user;
                updateNavAuth(); // Swap nav to Logout
                populateCategoriesSelect(); // Load categories for edit
                loadOwnedBusinesses(); // Load user's businesses
                document.getElementById('search-business').addEventListener('input', searchBusinesses); // Add search listener
            }

            // Load user's claimed businesses from Supabase
            async function loadOwnedBusinesses() {
                const { data, error } = await supabaseClient.from('businesses').select('*').eq('owner_id', currentUser.id);
                if (error) {
                    console.error('Error loading owned:', error);
                    return;
                }
                console.log('Loaded businesses:', data);
                const listDiv = document.getElementById('owned-list');
                listDiv.innerHTML = '';
                if (!data || data.length === 0) {
                    listDiv.innerHTML = '<p>No businesses yet—claim or add one!</p>';
                    return;
                }
                data.forEach(business => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-lg shadow-md';
                    card.innerHTML = '<h3 class="text-lg font-bold">' + (business.name || 'No Name') + '</h3>' +
                        '<p>' + (business.address || 'No Address') + '</p>' +
                        '<p>Status: ' + (business.claim_status || 'unclaimed') + '</p>';
                    if (business.claim_status === 'approved') {
                        const editBtn = document.createElement('button');
                        editBtn.textContent = 'Edit';
                        editBtn.className = 'bg-blue-500 text-white p-2 rounded mt-2';
                        editBtn.onclick = () => showEditForm(business);
                        card.appendChild(editBtn);
                    } else if (business.claim_status === 'pending') {
                        card.innerHTML += '<p class="text-yellow-500">Pending approval</p>';
                    }
                    listDiv.appendChild(card);
                });
            }

            // Toggle search section visibility
            function toggleSearch() {
                document.getElementById('search-section').classList.toggle('hidden');
            }

            // Search for unclaimed businesses
            async function searchBusinesses(event) {
                const query = event.target.value.toLowerCase();
                if (query.length < 3) {
                    document.getElementById('search-results').innerHTML = '';
                    return;
                }
                const { data, error } = await supabaseClient.from('businesses').select('*').ilike('name', `%${query}%`).eq('claim_status', 'unclaimed');
                if (error) console.error('Search error:', error);
                const resultsDiv = document.getElementById('search-results');
                resultsDiv.innerHTML = '';
                data.forEach(business => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-lg shadow-md';
                    card.innerHTML = '<h3 class="text-lg font-bold">' + (business.name || 'No Name') + '</h3>' +
                        '<p>' + (business.address || 'No Address') + '</p>';
                    const requestBtn = document.createElement('button');
                    requestBtn.textContent = 'Request Claim';
                    requestBtn.className = 'bg-green-500 text-white p-2 rounded mt-2';
                    requestBtn.onclick = () => requestClaim(business.id);
                    card.appendChild(requestBtn);
                    resultsDiv.appendChild(card);
                });
            }
            async function sendGHLNotification(eventType, details, email = currentUser.email) {
                try {
                    const response = await fetch('https://services.leadconnectorhq.com/hooks/miD90jDw7w2L2p1FaEpg/webhook-trigger/7b238155-630a-4776-9f3d-45a2757e8644', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ event: eventType, email, details, type: 'business' })  // Add type for tagging
                    });
                    if (response.ok) {
                        console.log('GHL notification sent for', eventType);
                    } else {
                        console.error('GHL notify failed:', response.status);
                    }
                } catch (err) {
                    console.error('GHL notify error:', err);
                }
            }
                    
            // Claim with code (limit check, update Supabase)
                async function claimWithCode() {
                        const code = document.getElementById('claim-code').value.trim();
                        if (!code) {
                            alert('Enter a code');
                            return;
                        }
                        // Check count
                        const { count, error: countError } = await supabaseClient.from('businesses').select('id', { count: 'exact' }).eq('owner_id', currentUser.id);
                        if (countError) {
                            alert('Error checking claims: ' + countError.message);
                            return;
                        }
                        const isPreAdded = true; // Assume pre-added for code (expand to check DB flag in Phase 2)
                        let status = 'pending';
                        if (count <= 2 && isPreAdded) status = 'approved'; // Auto-approve if under limit and pre-added
                        const { data: biz, error } = await supabaseClient.from('businesses').select('*').eq('claim_code', code).eq('claim_status', 'unclaimed').maybeSingle();
                        if (error || !biz) {
                            alert('Invalid code or already claimed');
                            return;
                        }
                        const update = { owner_id: currentUser.id, claim_status: status, claim_code: null };
                        const { data: updateData, error: updateError } = await supabaseClient.from('businesses').update(update).eq('id', biz.id).select();
                        console.log('Update result:', updateData, updateError);
                        if (updateError) {
                            alert('Claim error: ' + updateError.message);
                        } else if (!updateData.length) {
                            alert('Claim failed - no rows updated (check RLS)');
                        } else {
                            alert(`Claimed! Status: ${status.toUpperCase()}`);
                            loadOwnedBusinesses();
                            sendGHLNotification('claim_event', `New claim: ${status} for biz ID ${biz.id}, user: ${currentUser.id}`);
                        }
                    }

                async function requestClaim(id) {
                    const { count, error: countError } = await supabaseClient.from('businesses').select('id', { count: 'exact' }).eq('owner_id', currentUser.id);
                    if (countError) {
                        alert('Error checking claims: ' + countError.message);
                        return;
                    }
                    if (count > 2) {
                        alert('Limit reached (max 3 free). Contact support for review.');
                        return;
                    }
                    const update = { owner_id: currentUser.id, claim_status: 'pending' };
                    const { data: updateData, error } = await supabaseClient.from('businesses').update(update).eq('id', id).select();
                    console.log('Update result:', updateData, error);
                    if (error) {
                        alert('Request error: ' + error.message);
                    } else if (!updateData.length) {
                        alert('Request failed - no rows updated (check RLS)');
                    } else {
                        alert('Claim requested—waiting for approval.');
                        loadOwnedBusinesses();
                        sendGHLNotification(`New pending claim request for biz ID ${id}`); // Triggers follow-up
                   
                }
            }
            // Request claim via search (limit check, update Supabase)
            async function requestClaim(id) {
                    const { count, error: countError } = await supabaseClient.from('businesses').select('id', { count: 'exact' }).eq('owner_id', currentUser.id);
                    if (countError) {
                        alert('Error checking claims: ' + countError.message);
                        return;
                    }
                    if (count > 2) {
                        alert('You have reached the claim limit (max 2 for free users). Contact support.');
                        return;
                    }
                    const update = { owner_id: currentUser.id, claim_status: 'pending' };
                    const { data: updateData, error } = await supabaseClient.from('businesses').update(update).eq('id', id).select(); // Add .select() for returned row
                    console.log('Request update result:', updateData, error); // Better debug
                    if (error) {
                        alert('Request error: ' + error.message);
                    } else if (!updateData || updateData.length === 0) {
                        alert('Request failed - no rows updated (check RLS in Supabase)');
                    } else {
                        alert('Claim requested—waiting for approval.');
                        loadOwnedBusinesses();
                        // sendGHLNotification('New pending claim request'); // For Phase 2
                    }
                }

            // Show edit form for approved business
            function showEditForm(business) {
                if (business.claim_status !== 'approved') {
                    alert('Can\'t edit—pending approval');
                    return;
                }
                document.getElementById('edit-id').value = business.id;
                document.getElementById('name').value = business.name || '';
                document.getElementById('tagline').value = business.tagline || '';
                document.getElementById('description').value = business.description || '';
                document.getElementById('address').value = business.address || '';
                document.getElementById('website').value = business.website || '';
                document.getElementById('menu_url').value = business.menu_url || '';
                document.getElementById('facebook').value = business.social_links ? business.social_links.facebook : '';
                document.getElementById('instagram').value = business.social_links ? business.social_links.instagram : '';
                document.getElementById('twitter').value = business.social_links ? business.social_links.twitter : '';
                const categoriesSelect = document.getElementById('categories');
                Array.from(categoriesSelect.options).forEach(option => {
                    option.selected = (business.categories || []).includes(option.value);
                });
                document.getElementById('edit-form').style.display = 'block';
            }

            // Save edited business to Supabase
            async function saveBusiness() {
                const id = document.getElementById('edit-id').value;
                const { data: biz, error: bizError } = await supabaseClient.from('businesses').select('claim_status').eq('id', id).single();
                if (bizError || biz.claim_status !== 'approved') {
                    alert('Can\'t save—pending approval or error fetching status');
                    return;
                }
                const { data: profile, error: profileError } = await supabaseClient.from('profiles').select('membership_level').eq('id', currentUser.id).single();
                const membership = profile ? profile.membership_level : 'free';
                if (profileError) console.error('Profile error:', profileError);
                const name = document.getElementById('name').value;
                const tagline = document.getElementById('tagline').value;
                const description = document.getElementById('description').value;
                let address = document.getElementById('address').value;
                const website = document.getElementById('website').value;
                const menu_url = document.getElementById('menu_url').value;
                const social_links = {
                    facebook: document.getElementById('facebook').value,
                    instagram: document.getElementById('instagram').value,
                    twitter: document.getElementById('twitter').value
                };
                const categories = Array.from(document.getElementById('categories').selectedOptions).map(opt => opt.value);
                if (membership === 'free' && categories.length > 3) {
                    alert('Free membership limited to max 3 categories. Upgrade for more!');
                    return;
                }
                let latitude = null;
                let longitude = null;
                if (address) {
                    try {
                        const res = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=AIzaSyCs_qWUlsuNcc_5FPd41AhjwD4NyLz-I4k`);
                        const data = await res.json();
                        if (data.status === 'OK' && data.results.length > 0) {
                            latitude = data.results[0].geometry.location.lat;
                            longitude = data.results[0].geometry.location.lng;
                        } else {
                            alert(`Could not geocode address: ${data.error_message || 'Try adding city/state.'}`);
                            return;
                        }
                    } catch (err) {
                        alert('Geocoding error: ' + err.message);
                        return;
                    }
                }
                let logo_url = null;
                const logoFile = document.getElementById('logo-upload').files[0];
                if (logoFile) {
                    const { data, error } = await supabaseClient.storage.from('business-logos').upload(`${currentUser.id}/${logoFile.name}`, logoFile);
                    if (error) {
                        alert('Logo upload error: ' + error.message);
                        return;
                    }
                    logo_url = `${supabaseUrl}/storage/v1/object/public/business-logos/${data.path}`;
                }
                let photos = [];
                const { data: existing, error: existingError } = await supabaseClient.from('businesses').select('photos').eq('id', id).single();
                if (existingError) console.error('Existing photos error:', existingError);
                photos = existing.photos || [];
                const photoFiles = document.getElementById('photos-upload').files;
                for (let file of photoFiles) {
                    const { data, error } = await supabaseClient.storage.from('business-photos').upload(`${currentUser.id}/${file.name}`, file);
                    if (error) {
                        alert('Photo upload error: ' + error.message);
                        return;
                    }
                    photos.push(`${supabaseUrl}/storage/v1/object/public/business-photos/${data.path}`);
                }
                const updateData = {
                    name,
                    tagline,
                    description,
                    address,
                    website,
                    menu_url,
                    social_links,
                    categories,
                    latitude,
                    longitude,
                    photos
                };
                if (logo_url) updateData.logo_url = logo_url;
                const { error } = await supabaseClient.from('businesses').update(updateData).eq('id', id).eq('owner_id', currentUser.id);
                if (error) {
                    alert('Save error: ' + error.message);
                } else {
                    cancelEdit();
                    loadOwnedBusinesses();
                }
            }

            // Cancel edit (hide form)
            function cancelEdit() {
                document.getElementById('edit-form').style.display = 'none';
            }

           async function syncUserToGHL(email, type = 'customer') {
    try {
        await fetch('https://services.leadconnectorhq.com/hooks/miD90jDw7w2L2p1FaEpg/webhook-trigger/7b238155-630a-4776-9f3d-45a2757e8644', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ event: 'new_user', email, type })
        });
        console.log('User synced to GHL with type:', type);
    } catch (err) {
        console.error('GHL sync error:', err);
    }
}

            // Start dashboard on page load
            document.addEventListener('DOMContentLoaded', () => {
                initDashboard();
            });
    </script>
</body>
</html>