<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SupportLocalSLC</title>
    <link href="./output.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 font-sans">
    <header class="shadow-md">
        <div class="w-full h-40 md:h-48 lg:h-auto overflow-hidden">
            <img src="https://storage.googleapis.com/msgsndr/ZPvezSzdrR59azHbDrVt/media/687154c0f85f420c26bbfd37.jpeg" alt="Support Local SLC Banner" class="w-full h-full object-cover object-bottom lg:h-auto lg:object-contain">
        </div>
    </header>
        <nav class="fixed bottom-0 left-0 w-full bg-blue-800 shadow-md flex justify-around items-center py-2 z-50">
            <a href="index.html" class="text-yellow-300 hover:text-white flex flex-col items-center">
                <i class="fas fa-home text-2xl"></i>
                <span class="text-sm font-semibold">Home</span>
            </a>
            <a id="auth-link" href="login.html" class="text-yellow-300 hover:text-white flex flex-col items-center">
                <i class="fas fa-sign-in-alt text-2xl"></i>
                <span class="text-sm font-semibold">Login</span>
            </a>
            <a href="dashboard.html" class="text-yellow-300 hover:text-white flex flex-col items-center">
                <i class="fas fa-user-cog text-2xl"></i>
                <span class="text-sm font-semibold">Dashboard</span>
            </a>
        </nav>
    <main class="container mx-auto p-4">
        <h2 class="text-xl font-semibold mb-4">Claim or Edit Your Business</h2>
        <div class="mb-4">
            <input id="claim-code" type="text" placeholder="Enter your claim code..." class="w-full p-2 border rounded">
            <button onclick="claimWithCode()" class="bg-green-500 text-white p-2 rounded w-full mt-2">Claim with Code</button>
        </div>
        <button onclick="toggleSearch()" class="bg-blue-500 text-white p-2 rounded w-full mb-4">Search for My Business</button>
        <div id="search-section" class="hidden">
            <input id="search-business" type="text" placeholder="Search business name..." class="w-full p-2 mb-2 border rounded">
            <div id="search-results" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>
        <div id="owned-businesses" class="mt-8">
            <h3 class="text-lg font-bold mb-2">Your Businesses</h3>
            <div id="owned-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>
        <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white p-6 rounded shadow-md max-w-lg w-full max-h-[80vh] overflow-y-auto">
                <h3 class="text-lg font-bold mb-4">Edit Business</h3>
                <input type="hidden" id="edit-id">
                <input type="text" id="name" placeholder="Business Name" class="w-full p-2 mb-2 border rounded" required>
                <input type="text" id="tagline" placeholder="Tagline" class="w-full p-2 mb-2 border rounded">
                <textarea id="description" placeholder="Description" class="w-full p-2 mb-2 border rounded"></textarea>
                <input type="text" id="address" placeholder="Address (e.g., 123 Main St, Sandy, UT)"
                    class="w-full p-2 mb-2 border rounded">
                <input type="url" id="website" placeholder="Website" class="w-full p-2 mb-2 border rounded">
                <input type="url" id="menu_url" placeholder="Menu URL" class="w-full p-2 mb-2 border rounded">
                <div class="mb-2">
                    <label>Social Links:</label>
                    <select id="social-select" class="w-full p-2 border rounded mb-2">
                        <option value="">Add a social site...</option>
                        <option value="facebook">Facebook</option>
                        <option value="instagram">Instagram</option>
                        <option value="twitter">X (Twitter)</option>
                        <option value="tiktok">TikTok</option>
                        <option value="youtube">YouTube</option>
                        <option value="linkedin">LinkedIn</option>
                    </select>
                    <button onclick="addSocialField(document.getElementById('social-select').value)"
                        class="bg-blue-500 text-white p-2 rounded w-full mb-2">Add Selected</button>
                    <div id="social-fields"></div>
                </div>
                <div class="mb-2" id="category-container">
                    <label>Categories (search/select up to tier limit):</label>
                    <!-- Populated by script -->
                </div>
                <div class="mb-2">
                    <label>Logo Upload:</label>
                    <input type="file" id="logo-upload" accept="image/*" class="w-full">
                </div>
                <div class="mb-2">
                    <label>Photos Upload (multiple):</label>
                    <input type="file" id="photos-upload" accept="image/*" multiple class="w-full">
                </div>
                <button onclick="saveBusiness()" class="bg-blue-500 text-white p-2 rounded w-full">Save</button>
                <button onclick="cancelEdit()" class="bg-gray-500 text-white p-2 rounded w-full mt-2">Cancel</button>
            </div>
        </div>
    </main>
    
    <script type="module">
        const supabaseUrl = 'https://kozlfywdsqjndcsibgtw.supabase.co';
            const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtvemxmeXdkc3FqbmRjc2liZ3R3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyNTk0NzEsImV4cCI6MjA2NzgzNTQ3MX0.Xb0nRQIVhpW_7uBcwfIuvGZmyPMGzJq6k-6fdgfF3kw';
            const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);
            import { predefinedCategories } from './categories.js';
            let currentUser;
            
            // Hide edit form on load (prevents it showing by mistake)
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('edit-modal').style.display = 'none';
            });

            // Dynamic nav swap (Login to Logout based on session)
            async function updateNavAuth() {
                const storedSession = sessionStorage.getItem('supabase_session');
                const authLink = document.getElementById('auth-link');
                if (!authLink) {
                    console.log('No auth link found');
                    return;
                }
                const iconElement = authLink.querySelector('svg, i');
                const textSpan = authLink.querySelector('span');
                console.log('Stored session:', storedSession ? 'Yes' : 'No'); // Debug
                if (storedSession) {
                    authLink.href = '#';
                    authLink.onclick = async function (e) {
                        e.preventDefault();
                        await supabaseClient.auth.signOut();
                        sessionStorage.removeItem('supabase_session');
                        console.log('Logged out');
                        window.location.href = 'login.html';
                    };
                    if (iconElement) iconElement.classList.replace('fa-sign-in-alt', 'fa-sign-out-alt');
                    if (textSpan) textSpan.textContent = 'Logout';
                    console.log('Swapped to Logout');
                } else {
                    authLink.href = 'login.html';
                    authLink.onclick = null;
                    if (iconElement) iconElement.classList.replace('fa-sign-out-alt', 'fa-sign-in-alt');
                    if (textSpan) textSpan.textContent = 'Login';
                    console.log('Swapped to Login');
                }
            }

            // Fill categories dropdown for edit form
            function toggleSubs(radio) {
                    const allMains = document.querySelectorAll('#category-container div.mb-4');
                    allMains.forEach(div => {
                        const search = div.querySelector('input[type="text"]');
                        const ul = div.querySelector('ul');
                        if (div.querySelector('input[type="radio"]') === radio) {
                            search.classList.remove('hidden');
                            ul.classList.remove('hidden');
                        } else {
                            search.classList.add('hidden');
                            ul.classList.add('hidden');
                            // Uncheck subs in other mains
                            div.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                        }
                    });
                }
            
            function populateCategories() {
                    const container = document.getElementById('category-container');
                    container.innerHTML = '';
                    Object.entries(predefinedCategories).forEach(([main, subs]) => {
                        const mainDiv = document.createElement('div');
                        mainDiv.className = 'mb-4';
                        mainDiv.innerHTML = `<label class="flex items-center font-bold mb-2">
            <input type="radio" name="main-category" value="${main}" class="mr-2" onclick="toggleSubs(this)" />
            ${main}
        </label>`;
                        const searchInput = document.createElement('input');
                        searchInput.type = 'text';
                        searchInput.placeholder = `Search in ${main}...`;
                        searchInput.className = 'w-full p-2 border rounded mb-2 hidden';
                        searchInput.addEventListener('input', (e) => filterSubs(e.target.value, mainDiv));
                        mainDiv.appendChild(searchInput);
                        const ul = document.createElement('ul');
                        ul.className = 'max-h-32 overflow-y-auto hidden';
                        Object.entries(subs).forEach(([sub, subSubs]) => {
                            const li = document.createElement('li');
                            li.className = 'flex flex-col mb-2';
                            li.innerHTML = `
                <label class="flex items-center">
                    <input type="checkbox" value="${main} > ${sub}" class="mr-2" />
                    ${sub}
                </label>
            `;
                            if (subSubs.length > 0) {
                                const subUl = document.createElement('ul');
                                subUl.className = 'ml-4';
                                subSubs.forEach(subSub => {
                                    const subLi = document.createElement('li');
                                    subLi.innerHTML = `
                        <label class="flex items-center">
                            <input type="checkbox" value="${main} > ${sub} > ${subSub}" class="mr-2" />
                            ${subSub}
                        </label>
                    `;
                                    subUl.appendChild(subLi);
                                });
                                li.appendChild(subUl);
                            }
                            ul.appendChild(li);
                        });
                        mainDiv.appendChild(ul);
                        container.appendChild(mainDiv);
                    });
                }


                function filterSubs(term, mainDiv) {
                    const lowerTerm = term.toLowerCase();
                    const items = mainDiv.querySelectorAll('li');
                    items.forEach(item => {
                        const label = item.querySelector('label').textContent.toLowerCase();
                        item.style.display = label.includes(lowerTerm) ? 'block' : 'none';
                    });
                } 

            // Init dashboard (restore session, check auth, load stuff)
            async function initDashboard() {
                const storedSession = sessionStorage.getItem('supabase_session');
                if (storedSession) {
                    const session = JSON.parse(storedSession);
                    const { error } = await supabaseClient.auth.setSession(session);
                    if (error) console.error('Session set error:', error);
                }
                const { data, error: userError } = await supabaseClient.auth.getUser();
                if (userError || !data || !data.user) {
                    console.error('Auth error:', userError || 'No user data');
                    window.location.href = 'login.html';
                    return;
                }
                currentUser = data.user;
                updateNavAuth(); // Swap nav to Logout
                populateCategories(); // Load categories for edit
                loadOwnedBusinesses(); // Load user's businesses
                document.getElementById('search-business').addEventListener('input', searchBusinesses); // Add search listener
            }

            // Load user's claimed businesses from Supabase
            async function loadOwnedBusinesses() {
                const { data, error } = await supabaseClient.from('businesses').select('*').eq('owner_id', currentUser.id);
                if (error) {
                    console.error('Error loading owned:', error);
                    return;
                }
                console.log('Loaded businesses:', data);
                const listDiv = document.getElementById('owned-list');
                listDiv.innerHTML = '';
                if (!data || data.length === 0) {
                    listDiv.innerHTML = '<p>No businesses yet—claim or add one!</p>';
                    return;
                }
                data.forEach(business => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-lg shadow-md';
                    card.innerHTML = '<h3 class="text-lg font-bold">' + (business.name || 'No Name') + '</h3>' +
                        '<p>' + (business.address || 'No Address') + '</p>' +
                        '<p>Status: ' + (business.claim_status || 'unclaimed') + '</p>';
                    if (business.claim_status === 'approved') {
                        const editBtn = document.createElement('button');
                        editBtn.textContent = 'Edit';
                        editBtn.className = 'bg-blue-500 text-white p-2 rounded mt-2';
                        editBtn.onclick = () => {
                            console.log('Edit button clicked for business ID:', business.id);
                            showEditForm(business);
                        };
                        card.appendChild(editBtn);
                    }
                    else if (business.claim_status === 'pending') {
                        card.innerHTML += '<p class="text-yellow-500">Pending approval</p>';
                    }
                    listDiv.appendChild(card);
                });
            }

            // Toggle search section visibility
            function toggleSearch() {
                document.getElementById('search-section').classList.toggle('hidden');
            }

            // Search for unclaimed businesses
            async function searchBusinesses(event) {
                const query = event.target.value.toLowerCase();
                if (query.length < 3) {
                    document.getElementById('search-results').innerHTML = '';
                    return;
                }
                const { data, error } = await supabaseClient.from('businesses').select('*').ilike('name', `%${query}%`).eq('claim_status', 'unclaimed');
                if (error) console.error('Search error:', error);
                const resultsDiv = document.getElementById('search-results');
                resultsDiv.innerHTML = '';
                data.forEach(business => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-lg shadow-md';
                    card.innerHTML = '<h3 class="text-lg font-bold">' + (business.name || 'No Name') + '</h3>' +
                        '<p>' + (business.address || 'No Address') + '</p>';
                    const requestBtn = document.createElement('button');
                    requestBtn.textContent = 'Request Claim';
                    requestBtn.className = 'bg-green-500 text-white p-2 rounded mt-2';
                    requestBtn.onclick = () => requestClaim(business.id);
                    card.appendChild(requestBtn);
                    resultsDiv.appendChild(card);
                });
            }
            async function sendGHLNotification(eventType, details, email = currentUser.email) {
                try {
                    const response = await fetch('https://services.leadconnectorhq.com/hooks/miD90jDw7w2L2p1FaEpg/webhook-trigger/7b238155-630a-4776-9f3d-45a2757e8644', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ event: eventType, email, details, type: 'business' })  // Add type for tagging
                    });
                    if (response.ok) {
                        console.log('GHL notification sent for', eventType);
                    } else {
                        console.error('GHL notify failed:', response.status);
                    }
                } catch (err) {
                    console.error('GHL notify error:', err);
                }
            }
                    
            // Claim with code (limit check, update Supabase)
                async function claimWithCode() {
                        const code = document.getElementById('claim-code').value.trim();
                        if (!code) {
                            alert('Enter a code');
                            return;
                        }
                        // Check count
                        const { count, error: countError } = await supabaseClient.from('businesses').select('id', { count: 'exact' }).eq('owner_id', currentUser.id);
                        if (countError) {
                            alert('Error checking claims: ' + countError.message);
                            return;
                        }
                        const isPreAdded = true; // Assume pre-added for code (expand to check DB flag in Phase 2)
                        let status = 'pending';
                        if (count <= 2 && isPreAdded) status = 'approved'; // Auto-approve if under limit and pre-added
                        const { data: biz, error } = await supabaseClient.from('businesses').select('*').eq('claim_code', code).eq('claim_status', 'unclaimed').maybeSingle();
                        if (error || !biz) {
                            alert('Invalid code or already claimed');
                            return;
                        }
                        const update = { owner_id: currentUser.id, claim_status: status, claim_code: null };
                        const { data: updateData, error: updateError } = await supabaseClient.from('businesses').update(update).eq('id', biz.id).select();
                        console.log('Update result:', updateData, updateError);
                        if (updateError) {
                            alert('Claim error: ' + updateError.message);
                        } else if (!updateData.length) {
                            alert('Claim failed - no rows updated (check RLS)');
                        } else {
                            alert(`Claimed! Status: ${status.toUpperCase()}`);
                            loadOwnedBusinesses();
                            sendGHLNotification('claim_event', `New claim: ${status} for biz ID ${biz.id}, user: ${currentUser.id}`);
                        }
                    }

                async function requestClaim(id) {
                    const { count, error: countError } = await supabaseClient.from('businesses').select('id', { count: 'exact' }).eq('owner_id', currentUser.id);
                    if (countError) {
                        alert('Error checking claims: ' + countError.message);
                        return;
                    }
                    if (count > 2) {
                        alert('Limit reached (max 3 free). Contact support for review.');
                        return;
                    }
                    const update = { owner_id: currentUser.id, claim_status: 'pending' };
                    const { data: updateData, error } = await supabaseClient.from('businesses').update(update).eq('id', id).select();
                    console.log('Update result:', updateData, error);
                    if (error) {
                        alert('Request error: ' + error.message);
                    } else if (!updateData.length) {
                        alert('Request failed - no rows updated (check RLS)');
                    } else {
                        alert('Claim requested—waiting for approval.');
                        loadOwnedBusinesses();
                        sendGHLNotification(`New pending claim request for biz ID ${id}`); // Triggers follow-up
                   
                }
            }
           
            // Show edit form for approved business
            function showEditForm(business) {
                    if (business.claim_status !== 'approved') {
                        alert('Can\'t edit—pending approval');
                        return;
                    }
                    document.getElementById('edit-id').value = business.id;
                    document.getElementById('name').value = business.name || '';
                    document.getElementById('tagline').value = business.tagline || '';
                    document.getElementById('description').value = business.description || '';
                    document.getElementById('address').value = business.address || '';
                    document.getElementById('website').value = business.website || '';
                    document.getElementById('menu_url').value = business.menu_url || '';
                    const modal = document.getElementById('edit-modal');
                    modal.style.display = 'flex';
                    console.log('Modal display set to:', modal.style.display); // Debug
                    // Delay to ensure categories populated
                    setTimeout(() => {
                        const checkboxes = document.querySelectorAll('#category-container input[type="checkbox"]');
                        checkboxes.forEach(cb => {
                            cb.checked = (business.categories || []).includes(cb.value);
                        });
                        // Pre-select main radio if any
                        const mains = document.querySelectorAll('input[name="main-category"]');
                        const selectedMain = business.categories && business.categories.length > 0 ? business.categories[0].split(' > ')[0] : null;
                        if (selectedMain) {
                            const radio = Array.from(mains).find(r => r.value === selectedMain);
                            if (radio) {
                                radio.checked = true;
                                toggleSubs(radio);
                            }
                        }
                        // Clear and pre-fill social fields
                        document.getElementById('social-fields').innerHTML = '';
                        if (business.social_links) {
                            Object.entries(business.social_links).forEach(([site, url]) => addSocialField(site, url));
                        }
                    }, 100); // Short delay for DOM ready
                }
            // Save edited business to Supabase
           
            function addSocialField(site = '', url = '') {
                    const fields = document.getElementById('social-fields');
                    const div = document.createElement('div');
                    div.className = 'flex mb-1';
                    div.innerHTML = `
                        <input type="text" value="${site}" class="w-1/3 p-2 border rounded mr-1" readonly>
                        <input type="url" value="${url}" class="flex-1 p-2 border rounded mr-1" placeholder="URL">
                        <button onclick="this.parentElement.remove()" class="bg-red-500 text-white p-2 rounded">Remove</button>
                    `;
                    fields.appendChild(div);
                }
            
            async function saveBusiness() {
                console.log('saveBusiness called');    
                    const id = document.getElementById('edit-id').value;
                    const { data: biz, error: bizError } = await supabaseClient.from('businesses').select('claim_status').eq('id', id).single();
                    if (bizError || biz.claim_status !== 'approved') {
                        alert('Can\'t save—pending approval or error fetching status');
                        return;
                    }
                    const { data: profile, error: profileError } = await supabaseClient.from('profiles').select('membership_level').eq('id', currentUser.id).single();
                    const membership = profile ? profile.membership_level : 'free';
                    if (profileError) console.error('Profile error:', profileError);
                    const name = document.getElementById('name').value;
                    const tagline = document.getElementById('tagline').value;
                    const description = document.getElementById('description').value;
                    let address = document.getElementById('address').value;
                    const website = document.getElementById('website').value;
                    const menu_url = document.getElementById('menu_url').value;
                    const social_links = {};
                        document.querySelectorAll('#social-fields div').forEach(div => {
                            const site = div.querySelector('input:first-child').value.trim().toLowerCase();
                            let url = div.querySelector('input[type="url"]').value.trim();
                            if (site && url) {
                                if (!url.startsWith('http')) url = `https://${url}`;
                                social_links[site] = url;
                            }
                        });
                    const categories = Array.from(document.querySelectorAll('#category-container input:checked')).map(cb => cb.value);
                    let maxCats = 3; // free default
                    if (membership === 'Growth') maxCats = 5;
                    if (membership === 'Pro') maxCats = 10;
                    if (categories.length > maxCats) {
                        alert(`Limited to max ${maxCats} categories on ${membership} tier. Upgrade for more!`);
                        return;
                    }
                    let latitude = null;
                    let longitude = null;
                    if (address) {
                        try {
                            const res = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=AIzaSyCs_qWUlsuNcc_5FPd41AhjwD4NyLz-I4k`);
                            const data = await res.json();
                            if (data.status === 'OK' && data.results.length > 0) {
                                latitude = data.results[0].geometry.location.lat;
                                longitude = data.results[0].geometry.location.lng;
                            } else {
                                alert(`Could not geocode address: ${data.error_message || 'Try adding city/state.'}`);
                                return;
                            }
                        } catch (err) {
                            alert('Geocoding error: ' + err.message);
                            return;
                        }
                    }
                    let logo_url = null;
                        const logoFile = document.getElementById('logo-upload').files[0];
                        if (logoFile) {
                            alert('Uploading logo...'); // Feedback start
                            const { data, error } = await supabaseClient.storage.from('business-logos').upload(`${currentUser.id}/${logoFile.name}`, logoFile);
                            if (error) {
                                alert('Logo upload error: ' + error.message);
                                return;
                            }
                            logo_url = `${supabaseUrl}/storage/v1/object/public/business-logos/${data.path}`;
                            console.log('Logo uploaded successfully');
                        }
                        let photos = [];
                    const { data: existing, error: existingError } = await supabaseClient.from('businesses').select('photos').eq('id', id).single();
                    if (existingError) console.error('Existing photos error:', existingError);
                    photos = existing.photos || [];
                    const photoFiles = document.getElementById('photos-upload').files;
                        if (photoFiles.length > 0) {
                            alert('Uploading photos...'); // Feedback start
                        }
                        for (let file of photoFiles) {
                            const { data, error } = await supabaseClient.storage.from('business-photos').upload(`${currentUser.id}/${file.name}`, file);
                            if (error) {
                                alert('Photo upload error: ' + error.message);
                                return;
                            }
                            photos.push(`${supabaseUrl}/storage/v1/object/public/business-photos/${data.path}`);
                        }
                        if (photoFiles.length > 0) {
                            console.log('Photos uploaded successfully');
                        }
                    const updateData = {
                        name,
                        tagline,
                        description,
                        address,
                        website,
                        menu_url,
                        social_links,
                        categories,
                        latitude,
                        longitude,
                        photos
                    };
                    if (logo_url) updateData.logo_url = logo_url;
                    const { error } = await supabaseClient.from('businesses').update(updateData).eq('id', id).eq('owner_id', currentUser.id);
                    if (error) {
                        alert('Save error: ' + error.message);
                    } else {
                        cancelEdit();
                        loadOwnedBusinesses();
                    }
                }

            // Cancel edit (hide form)
            function cancelEdit() {
                    document.getElementById('edit-modal').style.display = 'none';
                }
           async function syncUserToGHL(email, type = 'customer') {
    try {
        await fetch('https://services.leadconnectorhq.com/hooks/miD90jDw7w2L2p1FaEpg/webhook-trigger/7b238155-630a-4776-9f3d-45a2757e8644', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ event: 'new_user', email, type })
        });
        console.log('User synced to GHL with type:', type);
    } catch (err) {
        console.error('GHL sync error:', err);
    }
}

            // Start dashboard on page load
            document.addEventListener('DOMContentLoaded', () => {
                initDashboard();
            });
        window.saveBusiness = saveBusiness;
        window.cancelEdit = cancelEdit;
        window.claimWithCode = claimWithCode;
        window.toggleSearch = toggleSearch;
        window.requestClaim = requestClaim;
        window.addSocialField = addSocialField;
        window.toggleSubs = toggleSubs;
    </script>

</body>
</html>