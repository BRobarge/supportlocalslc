<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SupportLocalSLC</title>
    <link href="./output.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 font-sans">
    <header class="shadow-md">
        <div class="w-full h-40 md:h-48 lg:h-auto overflow-hidden">
            <img src="https://storage.googleapis.com/msgsndr/ZPvezSzdrR59azHbDrVt/media/687154c0f85f420c26bbfd37.jpeg" alt="Support Local SLC Banner" class="w-full h-full object-cover object-bottom lg:h-auto lg:object-contain">
        </div>
    </header>
        <nav class="fixed bottom-0 left-0 w-full bg-blue-800 shadow-md flex justify-around items-center py-2 z-50">
            <a href="index.html" class="text-yellow-300 hover:text-white flex flex-col items-center">
                <i class="fas fa-home text-2xl"></i>
                <span class="text-sm font-semibold">Home</span>
            </a>
            <a id="auth-link" href="login.html" class="text-yellow-300 hover:text-white flex flex-col items-center">
                <i class="fas fa-sign-in-alt text-2xl"></i>
                <span class="text-sm font-semibold">Login</span>
            </a>
            <a href="dashboard.html" class="text-yellow-300 hover:text-white flex flex-col items-center">
                <i class="fas fa-user-cog text-2xl"></i>
                <span class="text-sm font-semibold">Dashboard</span>
            </a>
        </nav>
    <main class="container mx-auto p-4">
        <div id="owned-businesses" class="mt-8">
            <h3 class="text-lg font-bold mb-2">Your Businesses</h3>
            <div id="owned-list" class="grid grid-cols-1 p-6 md:grid-cols-2 gap-4"></div>
        </div>        
        <h2 class="text-xl font-semibold mb-4">Claim or Edit Your Business</h2>
        <div class="mb-4">
            <input id="claim-code" type="text" placeholder="Enter your claim code..." class="w-full p-2 border rounded">
            <button onclick="claimWithCode()" class="bg-green-500 text-white p-2 rounded w-full mt-2">Claim with Code</button>
        </div>
        <button onclick="toggleSearch()" class="bg-blue-500 text-white p-2 rounded w-full mb-4">Search for My Business</button>
        <div id="search-section" class="hidden">
            <input id="search-business" type="text" placeholder="Search business name..." class="w-full p-2 mb-2 border rounded">
            <div id="search-results" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>
        
        <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white p-6 rounded shadow-md max-w-lg w-full max-h-[80vh] overflow-y-auto">
                <h3 class="text-lg font-bold mb-4">Edit Business</h3>
                <input type="hidden" id="edit-id">
                <input type="text" id="name" placeholder="Business Name" class="w-full p-2 mb-2 border rounded" required>
                <input type="text" id="tagline" placeholder="Tagline" class="w-full p-2 mb-2 border rounded">
                <textarea id="description" placeholder="Description" class="w-full p-2 mb-2 border rounded"></textarea>
                <input type="text" id="address" placeholder="Address (e.g., 123 Main St, Sandy, UT)"
                    class="w-full p-2 mb-2 border rounded">
                <input type="url" id="website" placeholder="Website" class="w-full p-2 mb-2 border rounded">
                <input type="url" id="menu_url" placeholder="Menu URL" class="w-full p-2 mb-2 border rounded">
                <div class="mb-2">
                    <label>Social Links:</label>
                    <select id="social-select" class="w-full p-2 border rounded mb-2">
                        <option value="">Add a social site...</option>
                        <option value="facebook">Facebook</option>
                        <option value="instagram">Instagram</option>
                        <option value="twitter">X (Twitter)</option>
                        <option value="tiktok">TikTok</option>
                        <option value="youtube">YouTube</option>
                        <option value="linkedin">LinkedIn</option>
                    </select>
                    <button onclick="addSocialField(document.getElementById('social-select').value)"
                        class="bg-blue-500 text-white p-2 rounded w-full mb-2">Add Selected</button>
                    <div id="social-fields"></div>
                </div>
                <div class="mb-2" id="category-container">
                    <label>Categories (search/select up to tier limit):</label>
                    <!-- Populated by script -->
                </div>
                <div class="mb-2">
                    <label>Logo Upload:</label>
                    <input type="file" id="logo-upload" accept="image/*" class="w-full">
                </div>
                <div class="mb-2">
                    <label>Photos Upload (multiple):</label>
                    <input type="file" id="photos-upload" accept="image/*" multiple class="w-full">
                </div>
                <button onclick="saveBusiness()" class="bg-blue-500 text-white p-2 rounded w-full">Save</button>
                <button onclick="cancelEdit()" class="bg-gray-500 text-white p-2 rounded w-full mt-2">Cancel</button>
            </div>
        </div>
    </main>
    
    <script type="module">
        const supabaseUrl = 'https://kozlfywdsqjndcsibgtw.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtvemxmeXdkc3FqbmRjc2liZ3R3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyNTk0NzEsImV4cCI6MjA2NzgzNTQ3MX0.Xb0nRQIVhpW_7uBcwfIuvGZmyPMGzJq6k-6fdgfF3kw';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);
        let currentUser;

        // Tier config
        const tierLimits = {
            'free': { subs: 1, tags: 0 },
            'Growth': { subs: 2, tags: 3 },
            'Pro': { subs: 3, tags: 5 }
        };

        // Hide edit form on load
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('edit-modal').style.display = 'none';
        });

        // Dynamic nav swap
        async function updateNavAuth() {
            const storedSession = sessionStorage.getItem('supabase_session');
            const authLink = document.getElementById('auth-link');
            if (!authLink) return;
            const iconElement = authLink.querySelector('svg, i');
            const textSpan = authLink.querySelector('span');
            if (storedSession) {
                authLink.href = '#';
                authLink.onclick = async (e) => {
                    e.preventDefault();
                    await supabaseClient.auth.signOut();
                    sessionStorage.removeItem('supabase_session');
                    window.location.href = 'login.html';
                };
                if (iconElement) iconElement.classList.replace('fa-sign-in-alt', 'fa-sign-out-alt');
                if (textSpan) textSpan.textContent = 'Logout';
            } else {
                authLink.href = 'login.html';
                authLink.onclick = null;
                if (iconElement) iconElement.classList.replace('fa-sign-out-alt', 'fa-sign-in-alt');
                if (textSpan) textSpan.textContent = 'Login';
            }
        }

        // Toggle subs under main
        function toggleSubs(radio) {
            const allMains = document.querySelectorAll('#category-container div.mb-4');
            allMains.forEach(div => {
                const search = div.querySelector('input[type="text"]');
                const ul = div.querySelector('ul');
                if (div.querySelector('input[type="radio"]') === radio) {
                    search.classList.remove('hidden');
                    ul.classList.remove('hidden');
                } else {
                    search.classList.add('hidden');
                    ul.classList.add('hidden');
                    div.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                    div.querySelectorAll('ul li ul').forEach(u => u.classList.add('hidden'));
                }
            });
        }

        // Toggle tags under sub
        function toggleTags(checkbox) {
            const li = checkbox.closest('li');
            const tagsUl = li.querySelector('ul');
            if (tagsUl) {
                tagsUl.classList.toggle('hidden', !checkbox.checked);
            }
            if (!checkbox.checked) {
                li.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            }
        }

        // Populate categories with limits
        async function populateCategories(membership) {
            const container = document.getElementById('category-container');
            container.innerHTML = '';
            const limits = tierLimits[membership] || tierLimits['free'];
            const subCounter = document.createElement('p');
            subCounter.id = 'sub-counter';
            subCounter.className = 'text-sm text-gray-600 mb-2';
            container.appendChild(subCounter);
            const tagCounter = document.createElement('p');
            tagCounter.id = 'tag-counter';
            tagCounter.className = 'text-sm text-gray-600 mb-2';
            container.appendChild(tagCounter);

            // Fetch all categories from Supabase
            const { data: categories, error } = await supabaseClient.from('categories').select('*');
            if (error) {
                console.error('Error fetching categories:', error);
                container.innerHTML += '<p class="text-red-500">Error loading categories</p>';
                return;
            }

            // Build hierarchy: mains (level 1), subs (level 2), tags (level 3)
            const mains = categories.filter(c => c.level === 1).sort((a, b) => a.name.localeCompare(b.name));
            mains.forEach(main => {
                const mainDiv = document.createElement('div');
                mainDiv.className = 'mb-4';
                mainDiv.innerHTML = `<label class="flex items-center font-bold mb-2">
                    <input type="radio" name="main-category" value="${main.id}" class="mr-2" onclick="toggleSubs(this)" />
                    ${main.name}
                </label>`;
                const searchInput = document.createElement('input');
                searchInput.type = 'text';
                searchInput.placeholder = `Search in ${main.name}...`;
                searchInput.className = 'w-full p-2 border rounded mb-2 hidden';
                searchInput.addEventListener('input', (e) => filterSubs(e.target.value, mainDiv));
                mainDiv.appendChild(searchInput);
                const ul = document.createElement('ul');
                ul.className = 'max-h-32 overflow-y-auto hidden';

                // Fetch subs for this main
                const subs = categories.filter(c => c.parent_id === main.id && c.level === 2).sort((a, b) => a.name.localeCompare(b.name));
                subs.forEach(sub => {
                    const li = document.createElement('li');
                    li.className = 'flex flex-col mb-2';
                    li.innerHTML = `
                        <label class="flex items-center">
                            <input type="checkbox" value="${sub.id}" class="mr-2 sub-checkbox" />
                            ${sub.name}
                        </label>
                    `;
                    li.querySelector('.sub-checkbox').addEventListener('change', (e) => {
                        toggleTags(e.target);
                        updateCounters(limits);
                    });
                    const tagsUl = document.createElement('ul');
                    tagsUl.className = 'ml-4 hidden';

                    // Fetch tags for this sub
                    const tags = categories.filter(c => c.parent_id === sub.id && c.level === 3).sort((a, b) => a.name.localeCompare(b.name));
                    tags.forEach(tag => {
                        const tagLi = document.createElement('li');
                        tagLi.innerHTML = `
                            <label class="flex items-center">
                                <input type="checkbox" value="${tag.id}" class="mr-2 tag-checkbox" />
                                ${tag.name}
                            </label>
                        `;
                        tagLi.querySelector('.tag-checkbox').addEventListener('change', () => updateCounters(limits));
                        tagsUl.appendChild(tagLi);
                    });
                    li.appendChild(tagsUl);
                    ul.appendChild(li);
                });
                mainDiv.appendChild(ul);
                container.appendChild(mainDiv);
            });

            // Event for limit enforcement
            container.addEventListener('change', (e) => enforceLimits(limits, e.target));
            updateCounters(limits);
        }

        // Update counters
        function updateCounters(limits) {
            const selectedSubs = document.querySelectorAll('.sub-checkbox:checked').length;
            const selectedTags = document.querySelectorAll('.tag-checkbox:checked').length;
            document.getElementById('sub-counter').textContent = `You can select ${limits.subs - selectedSubs} more subcategories.`;
            document.getElementById('tag-counter').textContent = `You can select ${limits.tags - selectedTags} more tags.`;
        }

        // Enforce limits (disable if exceeded)
        function enforceLimits(limits, changedInput) {
            const selectedSubs = document.querySelectorAll('.sub-checkbox:checked').length;
            const selectedTags = document.querySelectorAll('.tag-checkbox:checked').length;
            document.querySelectorAll('.sub-checkbox:not(:checked)').forEach(cb => cb.disabled = selectedSubs >= limits.subs);
            document.querySelectorAll('.tag-checkbox:not(:checked)').forEach(cb => cb.disabled = selectedTags >= limits.tags);
            // If uncheck, re-enable
            if (!changedInput.checked) {
                document.querySelectorAll('.sub-checkbox:not(:checked)').forEach(cb => cb.disabled = false);
                document.querySelectorAll('.tag-checkbox:not(:checked)').forEach(cb => cb.disabled = false);
            }
        }

        // Filter subs
        function filterSubs(term, mainDiv) {
            const lowerTerm = term.toLowerCase();
            const items = mainDiv.querySelectorAll('li');
            items.forEach(item => {
                const label = item.querySelector('label').textContent.toLowerCase();
                const subLabels = Array.from(item.querySelectorAll('ul li label')).map(l => l.textContent.toLowerCase());
                item.style.display = label.includes(lowerTerm) || subLabels.some(sl => sl.includes(lowerTerm)) ? 'block' : 'none';
            });
        }

        // Init dashboard
        async function initDashboard() {
            const storedSession = sessionStorage.getItem('supabase_session');
            if (storedSession) {
                const session = JSON.parse(storedSession);
                const { error } = await supabaseClient.auth.setSession(session);
                if (error) console.error('Session set error:', error);
            }
            const { data, error: userError } = await supabaseClient.auth.getUser();
            if (userError || !data || !data.user) {
                console.error('Auth error:', userError || 'No user data');
                window.location.href = 'login.html';
                return;
            }
            currentUser = data.user;
            updateNavAuth();
            loadOwnedBusinesses();
            document.getElementById('search-business').addEventListener('input', searchBusinesses);
        }

        // Load owned
        async function loadOwnedBusinesses() {
            const { data, error } = await supabaseClient.from('businesses').select('*').eq('owner_id', currentUser.id);
            if (error) {
                console.error('Error loading owned:', error);
                return;
            }
            console.log('Loaded businesses:', data);
            const listDiv = document.getElementById('owned-list');
            listDiv.innerHTML = '';
            if (!data || data.length === 0) {
                listDiv.innerHTML = '<p>No businesses yet—claim or add one!</p>';
                return;
            }
            data.forEach(business => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow-md';
                card.innerHTML = '<h3 class="text-lg font-bold">' + (business.name || 'No Name') + '</h3>' +
                    '<p>' + (business.address || 'No Address') + '</p>' +
                    '<p>Status: ' + (business.claim_status || 'unclaimed') + '</p>';
                if (business.claim_status === 'approved') {
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Edit';
                    editBtn.className = 'bg-blue-500 text-white p-2 rounded mt-2';
                    editBtn.onclick = () => {
                        console.log('Edit button clicked for business ID:', business.id);
                        showEditForm(business);
                    };
                    card.appendChild(editBtn);
                } else if (business.claim_status === 'pending') {
                    card.innerHTML += '<p class="text-yellow-500">Pending approval</p>';
                }
                listDiv.appendChild(card);
            });
        }

        // Toggle search
        function toggleSearch() {
            document.getElementById('search-section').classList.toggle('hidden');
        }

        // Search businesses
        async function searchBusinesses(event) {
            const query = event.target.value.toLowerCase();
            if (query.length < 3) {
                document.getElementById('search-results').innerHTML = '';
                return;
            }
            const { data, error } = await supabaseClient.from('businesses').select('*').ilike('name', `%${query}%`).eq('claim_status', 'unclaimed');
            if (error) console.error('Search error:', error);
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '';
            data.forEach(business => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow-md';
                card.innerHTML = '<h3 class="text-lg font-bold">' + (business.name || 'No Name') + '</h3>' +
                    '<p>' + (business.address || 'No Address') + '</p>';
                const requestBtn = document.createElement('button');
                requestBtn.textContent = 'Request Claim';
                requestBtn.className = 'bg-green-500 text-white p-2 rounded mt-2';
                requestBtn.onclick = () => requestClaim(business.id);
                card.appendChild(requestBtn);
                resultsDiv.appendChild(card);
            });
        }

        // Send GHL
        async function sendGHLNotification(eventType, details, email = currentUser.email) {
            try {
                const response = await fetch('https://services.leadconnectorhq.com/hooks/miD90jDw7w2L2p1FaEpg/webhook-trigger/7b238155-630a-4776-9f3d-45a2757e8644', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ event: eventType, email, details, type: 'business' })  // Add type for tagging
                });
                if (response.ok) {
                    console.log('GHL notification sent for', eventType);
                } else {
                    console.error('GHL notify failed:', response.status);
                }
            } catch (err) {
                console.error('GHL notify error:', err);
            }
        }

        // Claim with code
        async function claimWithCode() {
            const code = document.getElementById('claim-code').value.trim();
            if (!code) {
                alert('Enter a code');
                return;
            }
            // Check count
            const { count, error: countError } = await supabaseClient.from('businesses').select('id', { count: 'exact' }).eq('owner_id', currentUser.id);
            if (countError) {
                alert('Error checking claims: ' + countError.message);
                return;
            }
            const isPreAdded = true; // Assume pre-added for code (expand to check DB flag in Phase 2)
            let status = 'pending';
            if (count <= 2 && isPreAdded) status = 'approved'; // Auto-approve if under limit and pre-added
            const { data: biz, error } = await supabaseClient.from('businesses').select('*').eq('claim_code', code).eq('claim_status', 'unclaimed').maybeSingle();
            if (error || !biz) {
                alert('Invalid code or already claimed');
                return;
            }
            const update = { owner_id: currentUser.id, claim_status: status, claim_code: null };
            const { data: updateData, error: updateError } = await supabaseClient.from('businesses').update(update).eq('id', biz.id).select();
            console.log('Update result:', updateData, updateError);
            if (updateError) {
                alert('Claim error: ' + updateError.message);
            } else if (!updateData.length) {
                alert('Claim failed - no rows updated (check RLS)');
            } else {
                alert(`Claimed! Status: ${status.toUpperCase()}`);
                loadOwnedBusinesses();
                sendGHLNotification('claim_event', `New claim: ${status} for biz ID ${biz.id}, user: ${currentUser.id}`);
            }
        }

        // Request claim
        async function requestClaim(id) {
            const { count, error: countError } = await supabaseClient.from('businesses').select('id', { count: 'exact' }).eq('owner_id', currentUser.id);
            if (countError) {
                alert('Error checking claims: ' + countError.message);
                return;
            }
            if (count > 2) {
                alert('Limit reached (max 3 free). Contact support for review.');
                return;
            }
            const update = { owner_id: currentUser.id, claim_status: 'pending' };
            const { data: updateData, error } = await supabaseClient.from('businesses').update(update).eq('id', id).select();
            console.log('Update result:', updateData, error);
            if (error) {
                alert('Request error: ' + error.message);
            } else if (!updateData.length) {
                alert('Request failed - no rows updated (check RLS)');
            } else {
                alert('Claim requested—waiting for approval.');
                loadOwnedBusinesses();
                sendGHLNotification(`New pending claim request for biz ID ${id}`); // Triggers follow-up
            }
        }

        // Show edit form
        async function showEditForm(business) {
            if (business.claim_status !== 'approved') {
                alert('Can\'t edit—pending approval');
                return;
            }
            if (!business) {
                console.error('No business data provided for edit');
                return;
            }
            document.getElementById('edit-id').value = business.id;
            document.getElementById('name').value = business.name || '';
            document.getElementById('tagline').value = business.tagline || '';
            document.getElementById('description').value = business.description || '';
            document.getElementById('address').value = business.address || '';
            document.getElementById('website').value = business.website || '';
            document.getElementById('menu_url').value = business.menu_url || '';
            const modal = document.getElementById('edit-modal');
            modal.style.display = 'flex';
            const { data: profile } = await supabaseClient.from('profiles').select('membership_level').eq('id', currentUser.id).single();
            const membership = profile ? profile.membership_level : 'free';
            populateCategories(membership); // Re-populate with limits
            if (business.categories && business.categories.length > 0) {
                setTimeout(async () => {
                    // Fetch all categories for mapping
                    const { data: allCategories } = await supabaseClient.from('categories').select('*');

                    // Pre-fill
                    const selectedPaths = business.categories || [];
                    if (selectedPaths.length > 0) {
                        const firstMainName = selectedPaths[0].split(' > ')[0];
                        const mainRadio = document.querySelector(`input[name="main-category"][value="${allCategories.find(c => c.name === firstMainName && c.level === 1)?.id}"]`);
                        if (mainRadio) {
                            mainRadio.checked = true;
                            toggleSubs(mainRadio);
                            selectedPaths.forEach(path => {
                                const parts = path.split(' > ');
                                if (parts.length === 2) { // Sub only
                                    const subId = allCategories.find(c => c.name === parts[1] && c.level === 2 && c.parent_id === mainRadio.value)?.id;
                                    const subCb = document.querySelector(`input.sub-checkbox[value="${subId}"]`);
                                    if (subCb) {
                                        subCb.checked = true;
                                        toggleTags(subCb);
                                    }
                                } else if (parts.length === 3) { // Tag
                                    const subId = allCategories.find(c => c.name === parts[1] && c.level === 2 && c.parent_id === mainRadio.value)?.id;
                                    const subCb = document.querySelector(`input.sub-checkbox[value="${subId}"]`);
                                    if (subCb) {
                                        subCb.checked = true;
                                        toggleTags(subCb);
                                        const tagId = allCategories.find(c => c.name === parts[2] && c.level === 3 && c.parent_id === subId)?.id;
                                        const tagCb = document.querySelector(`input.tag-checkbox[value="${tagId}"]`);
                                        if (tagCb) tagCb.checked = true;
                                    }
                                }
                            });
                        }
                    }
                    // Social pre-fill
                    document.getElementById('social-fields').innerHTML = '';
                    if (business.social_links) {
                        Object.entries(business.social_links).forEach(([site, url]) => addSocialField(site, url));
                    }
                    updateCounters(tierLimits[membership] || tierLimits['free']);
                }, 100);
            } else {
                updateCounters(tierLimits[membership] || tierLimits['free']);
            }
        }

        // Add social
        function addSocialField(site = '', url = '') {
            const fields = document.getElementById('social-fields');
            const div = document.createElement('div');
            div.className = 'flex mb-1';
            div.innerHTML = `
                <input type="text" value="${site}" class="w-1/3 p-2 border rounded mr-1" readonly>
                <input type="url" value="${url}" class="flex-1 p-2 border rounded mr-1" placeholder="URL">
                <button onclick="this.parentElement.remove()" class="bg-red-500 text-white p-2 rounded">Remove</button>
            `;
            fields.appendChild(div);
        }

        // Save business
        async function saveBusiness() {
            const id = document.getElementById('edit-id').value;
            const { data: biz, error: bizError } = await supabaseClient.from('businesses').select('claim_status').eq('id', id).single();
            if (bizError || biz.claim_status !== 'approved') {
                alert('Can\'t save—pending approval or error fetching status');
                return;
            }
            const { data: profile, error: profileError } = await supabaseClient.from('profiles').select('membership_level').eq('id', currentUser.id).single();
            const membership = profile ? profile.membership_level : 'free';
            const limits = tierLimits[membership] || tierLimits['free'];
            const name = document.getElementById('name').value;
            const tagline = document.getElementById('tagline').value;
            const description = document.getElementById('description').value;
            let address = document.getElementById('address').value;
            const website = document.getElementById('website').value;
            const menu_url = document.getElementById('menu_url').value;
            const social_links = {};
            document.querySelectorAll('#social-fields div').forEach(div => {
                const site = div.querySelector('input:first-child').value.trim().toLowerCase();
                let url = div.querySelector('input[type="url"]').value.trim();
                if (site && url) {
                    if (!url.startsWith('http')) url = `https://${url}`;
                    social_links[site] = url;
                }
            });

            // Fetch all categories for path building
            const { data: allCategories, error: catError } = await supabaseClient.from('categories').select('*');
            if (catError) {
                alert('Error fetching categories for save: ' + catError.message);
                return;
            }

            // Updated category collection (use IDs, but save full paths)
            const selectedSubCbs = document.querySelectorAll('#category-container input.sub-checkbox:checked');
            const subs = Array.from(selectedSubCbs).map(cb => cb.value);
            const mains = new Set();
            subs.forEach(subId => {
                const sub = allCategories.find(c => c.id === subId);
                if (sub) {
                    const main = allCategories.find(c => c.id === sub.parent_id);
                    if (main) mains.add(main.id);
                }
            });
            if (subs.length > 0 && mains.size !== 1) {
                alert('All subs must be under the same main category.');
                return;
            }
            const selectedTagCbs = document.querySelectorAll('#category-container input.tag-checkbox:checked');
            const selectedTagsCount = selectedTagCbs.length;
            if (subs.length > limits.subs) {
                alert(`Limited to max ${limits.subs} subs on ${membership} tier.`);
                return;
            }
            if (selectedTagsCount > limits.tags) {
                alert(`Limited to max ${limits.tags} tags on ${membership} tier.`);
                return;
            }
            let categoriesFull = [];
            // Function to get full path
            const getPath = (id) => {
                const item = allCategories.find(c => c.id === id);
                if (!item) return '';
                if (item.level === 1) return item.name;
                const parent = allCategories.find(c => c.id === item.parent_id);
                if (!parent) return item.name;
                const grandparent = parent.level === 2 ? allCategories.find(c => c.id === parent.parent_id) : null;
                return [grandparent?.name, parent.name, item.name].filter(Boolean).join(' > ');
            };
            Array.from(selectedTagCbs).forEach(cb => {
                const path = getPath(cb.value);
                if (path) categoriesFull.push(path);
            });
            selectedSubCbs.forEach(subCb => {
                const li = subCb.closest('li');
                const checkedTagsInSub = li.querySelectorAll('input.tag-checkbox:checked');
                if (checkedTagsInSub.length === 0) {
                    const path = getPath(subCb.value);
                    if (path) categoriesFull.push(path);
                }
            });

            let latitude = null;
            let longitude = null;
            if (address) {
                try {
                    const res = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=AIzaSyCs_qWUlsuNcc_5FPd41AhjwD4NyLz-I4k`);
                    const data = await res.json();
                    if (data.status === 'OK' && data.results.length > 0) {
                        latitude = data.results[0].geometry.location.lat;
                        longitude = data.results[0].geometry.location.lng;
                    } else {
                        alert(`Could not geocode address: ${data.error_message || 'Try adding city/state.'}`);
                        return;
                    }
                } catch (err) {
                    alert('Geocoding error: ' + err.message);
                    return;
                }
            }
            let logo_url = null;
            const logoFile = document.getElementById('logo-upload').files[0];
            if (logoFile) {
                alert('Uploading logo...');
                const { data, error } = await supabaseClient.storage.from('business-logos').upload(`${currentUser.id}/${logoFile.name}`, logoFile);
                if (error) {
                    alert('Logo upload error: ' + error.message);
                    return;
                }
                logo_url = `${supabaseUrl}/storage/v1/object/public/business-logos/${data.path}`;
                console.log('Logo uploaded successfully');
            }
            let photos = [];
            const { data: existing, error: existingError } = await supabaseClient.from('businesses').select('photos').eq('id', id).single();
            if (existingError) console.error('Existing photos error:', existingError);
            photos = existing.photos || [];
            const photoFiles = document.getElementById('photos-upload').files;
            if (photoFiles.length > 0) {
                alert('Uploading photos...');
            }
            for (let file of photoFiles) {
                const { data, error } = await supabaseClient.storage.from('business-photos').upload(`${currentUser.id}/${file.name}`, file);
                if (error) {
                    alert('Photo upload error: ' + error.message);
                    return;
                }
                photos.push(`${supabaseUrl}/storage/v1/object/public/business-photos/${data.path}`);
            }
            if (photoFiles.length > 0) {
                console.log('Photos uploaded successfully');
            }
            const updateData = {
                name,
                tagline,
                description,
                address,
                website,
                menu_url,
                social_links,
                categories: categoriesFull,
                latitude,
                longitude,
                photos
            };
            if (logo_url) updateData.logo_url = logo_url;
            const { error } = await supabaseClient.from('businesses').update(updateData).eq('id', id).eq('owner_id', currentUser.id);
            if (error) {
                alert('Save error: ' + error.message);
            } else {
                cancelEdit();
                loadOwnedBusinesses();
            }
        }

        // Cancel edit
        function cancelEdit() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        // Sync GHL
        async function syncUserToGHL(email, type = 'customer') {
            try {
                await fetch('https://services.leadconnectorhq.com/hooks/miD90jDw7w2L2p1FaEpg/webhook-trigger/7b238155-630a-4776-9f3d-45a2757e8644', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ event: 'new_user', email, type })
                });
                console.log('User synced to GHL with type:', type);
            } catch (err) {
                console.error('GHL sync error:', err);
            }
        }

        // Start dashboard
        document.addEventListener('DOMContentLoaded', () => {
            initDashboard();
        });
        window.saveBusiness = saveBusiness;
        window.cancelEdit = cancelEdit;
        window.claimWithCode = claimWithCode;
        window.toggleSearch = toggleSearch;
        window.requestClaim = requestClaim;
        window.addSocialField = addSocialField;
        window.toggleSubs = toggleSubs;
    </script>

</body>
</html>