<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Business - SupportLocalSLC</title>
    <!-- We use the root-relative path for our shared CSS -->
    <link href="/shared/output.css" rel="stylesheet">
    <script data-auto-replace-svg="false" src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"
        crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Add these inside the <head> of edit-business.html -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

</head>

<body class="bg-gray-100 font-sans">

    <!-- Header (can be simpler for the workspace ) -->
    <header class="bg-white shadow-md">
        <div class="container mx-auto p-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800" id="editing-header">Editing: Loading...</h1>
            <div>
                <a href="/dashboard.html" class="text-sm text-blue-600 hover:underline">&larr; Back to Dashboard</a>
                <a id="view-live-page-btn" href="#" target="_blank"
                    class="ml-4 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm hover:bg-blue-700 hidden">View
                    Live Page</a>
            </div>
        </div>
    </header>

    <!-- Main Workspace -->
    <main class="container mx-auto p-4 md:p-8">
        <div class="md:flex md:space-x-8">

            <!-- Left Side Navigation -->
            <aside class="md:w-1/4 mb-8 md:mb-0">
                <nav id="edit-nav" class="space-y-2">
                    <a href="#story" data-section="story" class="edit-nav-link active">
                        <i class="fas fa-book-open w-6 mr-3"></i> Story & Info
                    </a>
                    <a href="#photos" data-section="photos" class="edit-nav-link">
                        <i class="fas fa-camera-retro w-6 mr-3"></i> Photos & Gallery
                    </a>
                    <a href="#location" data-section="location" class="edit-nav-link">
                        <i class="fas fa-map-marker-alt w-6 mr-3"></i> Location & Hours
                    </a>
                    <a href="#contact" data-section="contact" class="edit-nav-link">
                        <i class="fas fa-address-book w-6 mr-3"></i> Contact & Social
                    </a>
                    <a href="#categories" data-section="categories" class="edit-nav-link">
                        <i class="fas fa-tags w-6 mr-3"></i> Categories
                    </a>
                    <a href="#offers" data-section="offers" class="edit-nav-link">
                        <i class="fas fa-star w-6 mr-3"></i> Offers
                    </a>
                </nav>
            </aside>

            <!-- Right Side Content Area -->
            <div class="md:w-3/4">
                <!-- The content for each section will be dynamically loaded here -->
                <div id="edit-content" class="bg-white p-8 rounded-lg shadow-lg">
                    <!-- Loading placeholder -->
                    <p>Loading content...</p>
                </div>
            </div>

        </div>

        <!-- In /public/edit-business.html, before </main> -->

        <!-- Add/Edit Offer Modal -->
        <div id="offer-modal"
            class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
            <div
                class="bg-white p-6 md:p-8 rounded-lg shadow-2xl w-full sm:w-auto sm:min-w-[600px] max-w-2xl max-h-[90vh] overflow-y-auto">




                <!-- Modal Header -->
                <div class="flex justify-between items-center mb-6">
                    <h2 id="offer-modal-title" class="text-2xl font-bold text-gray-800">Add New Offer</h2>
                    <button id="close-offer-modal-btn"
                        class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                </div>

                <!-- Offer Form -->
                <div class="space-y-4">
                    <input type="hidden" id="offer-id-input"> <!-- To store the ID when editing -->

                    <div>
                        <label for="offer-title" class="block text-sm font-medium text-gray-700">Offer Title</label>
                        <input type="text" id="offer-title" placeholder="e.g., 15% Off Your Entire Purchase"
                            class="mt-1 block w-full p-3 border border-gray-300 rounded-md">
                    </div>

                    <div>
                        <label for="offer-description" class="block text-sm font-medium text-gray-700">Description &
                            Terms</label>
                        <textarea id="offer-description" rows="4"
                            placeholder="e.g., Valid for first-time customers. Not valid with other discounts."
                            class="mt-1 block w-full p-3 border border-gray-300 rounded-md"></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="offer-pin" class="block text-sm font-medium text-gray-700">4-Digit Redemption
                                PIN</label>
                            <input type="text" id="offer-pin" placeholder="e.g., 1234" maxlength="4"
                                class="mt-1 block w-full p-3 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="offer-limit" class="block text-sm font-medium text-gray-700">Total Claim Limit
                                (Optional)</label>
                            <input type="number" id="offer-limit" placeholder="e.g., 100"
                                class="mt-1 block w-full p-3 border border-gray-300 rounded-md">
                        </div>
                        <div class="md:col-span-2">
                            <label for="offer-expires-at" class="block text-sm font-medium text-gray-700">Offer
                                Expiration Date
                                (Optional)</label>
                            <input type="date" id="offer-expires-at"
                                class="mt-1 block w-full p-3 border border-gray-300 rounded-md">
                            <p class="mt-1 text-xs text-gray-500">The offer will become hidden to customers after this
                                date.</p>
                        </div>
                    </div>

                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="offer-first-time"
                                class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="ml-3 font-medium text-gray-700">This offer is for first-time customers
                                only.</span>
                        </label>
                    </div>

                    <!-- Save Button -->
                    <div class="flex justify-end pt-4">
                        <button id="save-offer-btn"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg">Save
                            Offer</button>
                    </div>
                </div>
            </div>
        </div>


    </main>

    <!-- Add some basic CSS for the edit navigation -->
    <style>
        .edit-nav-link {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            color: #4B5563;
            /* gray-600 */
            transition: background-color 0.2s, color 0.2s;
            text-decoration: none;
        }

        .edit-nav-link:hover {
            background-color: #E5E7EB;
            /* gray-200 */
        }

        .edit-nav-link.active {
            background-color: #3B82F6;
            /* blue-500 */
            color: white;
        }

        .parent-has-selection {
            background-color: #DBEAFE !important;
            /* A light blue color (Tailwind's blue-100) */
            border-left: 4px solid #3B82F6;
            /* A solid blue left border */
        }
    </style>

    <!-- The JavaScript will go here -->
    <!-- Add this script block right before the closing </body> tag -->
    <script type="module">
        // --- CONFIGURATION & GLOBAL STATE ---
        const supabaseClient = supabase.createClient('https://kozlfywdsqjndcsibgtw.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtvemxmeXdkc3FqbmRjc2liZ3R3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyNTk0NzEsImV4cCI6MjA2NzgzNTQ3MX0.Xb0nRQIVhpW_7uBcwfIuvGZmyPMGzJq6k-6fdgfF3kw');
        let currentBusinessData = null;
        let currentUser = null;
        let quill = null;

        // --- HELPER FUNCTIONS ---
        function showToast(message, type = 'success') {
            const color = type === 'error' ? 'bg-red-600' : 'bg-green-600';
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 text-white text-sm px-4 py-3 rounded-lg shadow-lg ${color} z-[110]`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 300ms';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        function showUploadStatus(message, type = 'info') {
            const statusContainer = document.getElementById('upload-status');
            if (!statusContainer) return;
            let bgColor, textColor, icon;
            switch (type) {
                case 'error':
                    bgColor = 'bg-red-100'; textColor = 'text-red-700'; icon = '<i class="fas fa-times-circle mr-3"></i>';
                    break;
                case 'success':
                    bgColor = 'bg-green-100'; textColor = 'text-green-700'; icon = '<i class="fas fa-check-circle mr-3"></i>';
                    break;
                default:
                    bgColor = 'bg-blue-100'; textColor = 'text-blue-700'; icon = '<i class="fas fa-spinner fa-spin mr-3"></i>';
                    break;
            }
            statusContainer.innerHTML = `<div class="${bgColor} ${textColor} p-4 rounded-lg flex items-center" role="alert">${icon}<span class="font-medium">${message}</span></div>`;
            FontAwesome.dom.i2svg();
        }


        // --- MAIN INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            const businessId = new URLSearchParams(window.location.search).get('id');
            if (!businessId) {
                document.getElementById('edit-content').innerHTML = '<p class="text-red-500">Error: No business ID provided.</p>';
                return;
            }

            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) {
                window.location.href = `/login.html?redirect=/edit-business.html?id=${businessId}`;
                return;
            }
            currentUser = user;

            const { data: profile } = await supabaseClient.from('profiles').select('roles').eq('id', user.id).single();
            let query = supabaseClient.from('businesses').select('*, business_categories(category_id), business_tags(tag_id)').eq('id', businessId);

            if (!profile || !profile.roles.includes('admin')) {
                query = query.eq('owner_id', user.id);
            }

            const { data: business, error } = await query.single();

            if (error || !business) {
                console.error(error);
                document.getElementById('edit-content').innerHTML = '<p class="text-red-500">Error: Could not load business data or you do not have permission to edit this listing.</p>';
                return;
            }
            currentBusinessData = business;

            populateHeader(business);
            renderStorySection(); // Start on the first tab
            setupNavLinks();
            FontAwesome.dom.i2svg();
        });

        // --- NAVIGATION & SECTION RENDERING ---
        function setupNavLinks() {
            const navLinks = document.querySelectorAll('.edit-nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    navLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    const section = link.dataset.section;
                    const renderActions = {
                        story: renderStorySection,
                        photos: renderPhotosSection,
                        location: renderLocationSection,
                        contact: renderContactSection,
                        categories: renderCategoriesSection,
                        offers: renderOffersSection,
                    };


                    if (renderActions[section]) {
                        renderActions[section]();
                    }
                });
            });
        }

        function populateHeader(business) {
            document.getElementById('editing-header').textContent = `Editing: ${business.name}`;
            const livePageBtn = document.getElementById('view-live-page-btn');
            livePageBtn.href = `/${business.territory}/business.html?id=${business.id}`;
            livePageBtn.classList.remove('hidden');
        }

        // --- STORY SECTION ---
        function renderStorySection() {
                       const container = document.getElementById('edit-content');
            container.innerHTML = `
                                <h2 class="text-2xl font-bold mb-2">Story & Info</h2>
                                <p class="text-gray-600 mb-6">This is the heart of your profile. Tell your customers who you are and what makes you special.</p>
                                <div class="space-y-6">
                                    <div>
                                        <label for="business-name" class="block text-sm font-medium text-gray-700">Business Name</label>
                                        <input type="text" id="business-name" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm" value="${currentBusinessData.name || ''}">
                                    </div>
                                    <div>
                                        <label for="business-tagline" class="block text-sm font-medium text-gray-700">Tagline (a short, catchy phrase)</label>
                                        <input type="text" id="business-tagline" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm" value="${currentBusinessData.tagline || ''}">
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-lg border">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Business Logo</label>
                                        <div class="flex items-center space-x-6">
                                            <div id="logo-preview-container" class="w-48 h-32 bg-gray-200 flex items-center justify-center overflow-hidden shadow-inner rounded-lg"></div>
                                            <div class="flex-grow">
                                                <input type="file" id="logo-upload-input" accept="image/png, image/jpeg" class="hidden">
                                                <label for="logo-upload-input" class="cursor-pointer bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 border border-gray-300 rounded-lg shadow-sm"><i class="fas fa-upload mr-2"></i> Choose New Logo</label>
                                                <button id="delete-logo-btn" class="ml-2 cursor-pointer bg-red-100 hover:bg-red-200 text-red-700 font-semibold py-2 px-4 border border-red-200 rounded-lg shadow-sm"><i class="fas fa-trash-alt"></i></button>
                                                <p class="text-xs text-gray-500 mt-2">Max file size: 5MB. PNG or JPG format.</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Our Story / Description</label>
                                        <!-- Quill will take over this div -->
                                        <div id="quill-editor" class="mt-1 bg-white" style="height: 250px;"></div>
                                    </div>

                                    <div class="flex justify-end">
                                        <button id="save-story-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 disabled:bg-gray-400">Save Changes</button>
                                    </div>
                                </div>
                            `;
            const logoPreviewContainer = document.getElementById('logo-preview-container');
            if (currentBusinessData.logo_url) {
                logoPreviewContainer.innerHTML = `<img src="${currentBusinessData.logo_url}" alt="Current Logo" class="w-full h-full object-contain">`;
            } else {
                logoPreviewContainer.innerHTML = `<span class="text-gray-500 text-xs text-center">No Logo</span>`;
            }
            document.getElementById('logo-upload-input').addEventListener('change', handleLogoUpload);
            document.getElementById('delete-logo-btn').addEventListener('click', handleLogoDelete);
            // --- Initialize Quill Editor ---
            const quill = new Quill('#quill-editor', {
                theme: 'snow', // Use the 'snow' theme
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                        ['link'],
                        ['clean'] // Button to remove all formatting
                    ]
                }
            });

            // Load the existing story HTML into the editor
            if (currentBusinessData.description) {
                quill.root.innerHTML = currentBusinessData.description;
            }

            document.getElementById('save-story-btn').addEventListener('click', saveStorySection);

            FontAwesome.dom.i2svg(); // Manually render icons

        }
        async function saveStorySection() {
                       const saveBtn = document.getElementById('save-story-btn');
            saveBtn.textContent = 'Saving...';
            saveBtn.disabled = true;
            const updatedData = {
                name: document.getElementById('business-name').value,
                tagline: document.getElementById('business-tagline').value,
                // Get the HTML content from the Quill editor
                description: document.querySelector('#quill-editor .ql-editor').innerHTML,

            };
            const { data, error } = await supabaseClient.from('businesses').update(updatedData).eq('id', currentBusinessData.id).select().single();
            if (error) {
                console.error('Error updating story section:', error);
                alert('Error: Could not save changes.');
            } else {
                currentBusinessData = data;
                document.getElementById('editing-header').textContent = `Editing: ${updatedData.name}`;
                saveBtn.textContent = 'Saved!';
                setTimeout(() => { saveBtn.textContent = 'Save Changes'; }, 2000);
            }
            saveBtn.disabled = false;

        }

        // --- PHOTOS & LOGO SECTION ---
        function renderPhotosSection() {
                       const container = document.getElementById('edit-content');
            container.innerHTML = `
                            <h2 class="text-2xl font-bold mb-2">Photos & Gallery</h2>
                            <p class="text-gray-600 mb-6">Showcase your business, products, and team.</p>
                            <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-6 text-center mb-6">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                                <h3 class="text-lg font-medium text-gray-700">Drag and drop photos here</h3>
                                <p class="text-sm text-gray-500">or</p>
                                <input type="file" id="photos-upload-input" multiple accept="image/png, image/jpeg" class="hidden">
                                <label for="photos-upload-input" class="cursor-pointer text-blue-600 font-semibold hover:underline">Select files from your computer</label>
                                <p class="text-xs text-gray-500 mt-2">PNG or JPG files accepted.</p>
                            </div>
                            <div id="upload-status" class="mb-4"></div>
                            <h3 class="text-xl font-bold mb-4">Current Gallery</h3>
                            <div id="gallery-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
                        `;
            const galleryGrid = document.getElementById('gallery-grid');
            const photos = currentBusinessData.photos || [];
            if (photos.length === 0) {
                galleryGrid.innerHTML = '<p class="text-gray-500 col-span-full">No photos uploaded yet.</p>';
            } else {
                photos.forEach(photoUrl => {
                    const photoCard = document.createElement('div');
                    photoCard.className = 'relative group';
                    photoCard.innerHTML = `
                                    <img src="${photoUrl}" alt="Business Photo" class="w-full h-32 object-cover rounded-lg shadow-md z-10">
                                    <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-60 flex items-center justify-center transition-all duration-300 rounded-lg z-20">
                                        <button class="delete-photo-btn text-white text-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-300" data-url="${photoUrl}"><i class="fas fa-trash-alt"></i></button>
                                    </div>`;
                    galleryGrid.appendChild(photoCard);
                });
            }
            document.getElementById('photos-upload-input').addEventListener('change', handlePhotoUpload);
            galleryGrid.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-photo-btn');
                if (deleteBtn) handlePhotoDelete(deleteBtn.dataset.url);
            });

            FontAwesome.dom.i2svg(); // Manually render icons

        }
        async function handleLogoUpload(event) {
           const file = event.target.files[0];
            if (!file) return;
            const logoPreviewContainer = document.getElementById('logo-preview-container');
            logoPreviewContainer.innerHTML = `<div class="w-full h-full flex items-center justify-center"><i class="fas fa-spinner fa-spin text-2xl text-gray-500"></i></div>`;
            const filePath = `${currentUser.id}/${currentBusinessData.id}/logo-${Date.now()}`;
            const { error: uploadError } = await supabaseClient.storage.from('business-logos').upload(filePath, file, { cacheControl: '3600', upsert: true });
            if (uploadError) {
                alert(`Error uploading logo: ${uploadError.message}`);
                renderStorySection();
                return;
            }
            const { data: { publicUrl } } = supabaseClient.storage.from('business-logos').getPublicUrl(filePath);
            const { data, error: updateError } = await supabaseClient.from('businesses').update({ logo_url: publicUrl }).eq('id', currentBusinessData.id).select().single();
            if (updateError) {
                alert('Could not save the new logo to your profile.');
            } else {
                currentBusinessData = data;
                renderStorySection();
            }

        }
        async function handleLogoDelete() {
                        if (!currentBusinessData.logo_url) {
                alert("There is no logo to delete.");
                return;
            }
            if (!confirm("Are you sure you want to delete your business logo?")) return;
            const { data, error: updateError } = await supabaseClient.from('businesses').update({ logo_url: null }).eq('id', currentBusinessData.id).select().single();
            if (updateError) {
                alert("Could not delete the logo from your profile.");
            } else {
                try {
                    const filePath = currentBusinessData.logo_url.split('/business-logos/')[1];
                    await supabaseClient.storage.from('business-logos').remove([filePath]);
                } catch (storageError) {
                    console.error("Couldn't delete file from storage, but removed from profile.", storageError);
                }
                currentBusinessData = data;
                renderStorySection();
                alert("Logo deleted.");
            }

        }
        async function handlePhotoUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            showUploadStatus(`Uploading ${files.length} photo(s)...`, 'info');
            let existingPhotos = currentBusinessData.photos || [];
            let uploadSuccess = false;
            for (const file of files) {
                const filePath = `${currentUser.id}/${currentBusinessData.id}/${Date.now()}-${file.name}`;
                const { error: uploadError } = await supabaseClient.storage.from('business-photos').upload(filePath, file);
                if (uploadError) {
                    console.error('Error uploading photo:', uploadError);
                    showUploadStatus(`Error uploading ${file.name}: ${uploadError.message}`, 'error');
                    return;
                }
                const { data: { publicUrl } } = supabaseClient.storage.from('business-photos').getPublicUrl(filePath);
                existingPhotos.push(publicUrl);
                uploadSuccess = true;
            }
            if (!uploadSuccess) {
                document.getElementById('upload-status').innerHTML = '';
                return;
            }
            const { data, error: updateError } = await supabaseClient.from('businesses').update({ photos: existingPhotos }).eq('id', currentBusinessData.id).select().single();
            if (updateError) {
                console.error('Error updating business with new photos:', updateError);
                showUploadStatus('Could not save new photos to your profile.', 'error');
            } else {
                currentBusinessData = data;
                showUploadStatus('Upload complete!', 'success');
                setTimeout(() => { renderPhotosSection(); }, 2000);
            }

        }
        async function handlePhotoDelete(photoUrl) {
                        if (!confirm('Are you sure you want to delete this photo?')) return;
            let updatedPhotos = (currentBusinessData.photos || []).filter(url => url !== photoUrl);
            const { data, error: updateError } = await supabaseClient.from('businesses').update({ photos: updatedPhotos }).eq('id', currentBusinessData.id).select().single();
            if (updateError) {
                alert('Error deleting photo from profile.');
                return;
            }
            try {
                const filePath = photoUrl.split('/business-photos/')[1];
                await supabaseClient.storage.from('business-photos').remove([filePath]);
            } catch (storageError) {
                console.error("Couldn't delete file from storage, but removed from profile.", storageError);
            }
            currentBusinessData = data;
            renderPhotosSection();
            alert('Photo deleted.');

        }

        // --- LOCATION SECTION ---
        function renderLocationSection() {
                       const container = document.getElementById('edit-content');
            container.innerHTML = `
                            <h2 class="text-2xl font-bold mb-2">Location & Hours</h2>
                            <p class="text-gray-600 mb-6">Let customers know where to find you and when you're open.</p>
                            <div class="space-y-4 bg-gray-50 p-6 rounded-lg mb-8">
                                <h3 class="font-bold text-lg text-gray-800">Business Address</h3>
                                <div>
                                    <label for="address-street" class="block text-sm font-medium text-gray-700">Street Address</label>
                                    <input type="text" id="address-street" class="mt-1 block w-full p-3 border border-gray-300 rounded-md" value="${currentBusinessData.address || ''}">
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label for="address-city" class="block text-sm font-medium text-gray-700">City</label>
                                        <input type="text" id="address-city" class="mt-1 block w-full p-3 border border-gray-300 rounded-md" value="${currentBusinessData.city || ''}">
                                    </div>
                                    <div>
                                        <label for="address-state" class="block text-sm font-medium text-gray-700">State</label>
                                        <input type="text" id="address-state" class="mt-1 block w-full p-3 border border-gray-300 rounded-md" value="${currentBusinessData.state || ''}">
                                    </div>
                                    <div>
                                        <label for="address-zip" class="block text-sm font-medium text-gray-700">Zip Code</label>
                                        <input type="text" id="address-zip" class="mt-1 block w-full p-3 border border-gray-300 rounded-md" value="${currentBusinessData.zip_code || ''}">
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-4 bg-gray-50 p-6 rounded-lg">
                                <h3 class="font-bold text-lg text-gray-800">Hours of Operation</h3>
                                <div id="hours-inputs" class="space-y-3"></div>
                            </div>
                            <div class="flex justify-end mt-8">
                                <button id="save-location-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 disabled:bg-gray-400">Save Changes</button>
                            </div>
                        `;
            const hoursContainer = document.getElementById('hours-inputs');
            const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const hoursData = currentBusinessData.hours_data || {};
            daysOfWeek.forEach(day => {
                const dayData = hoursData[day] || { isOpen: false, is24Hours: false, from: '09:00', to: '17:00' };
                const dayRow = document.createElement('div');
                dayRow.className = 'grid grid-cols-1 md:grid-cols-4 items-center gap-3 p-2 rounded-md';
                dayRow.dataset.day = day;
                dayRow.innerHTML = `
                                <div class="md:col-span-1"><label class="flex items-center"><input type="checkbox" class="mr-2 h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 day-open-checkbox" ${dayData.isOpen ? 'checked' : ''}><span class="font-medium text-gray-800">${day}</span></label></div>
                                <div class="time-inputs md:col-span-3 flex items-center gap-2 ${dayData.isOpen ? '' : 'hidden'}">
                                    <input type="time" class="from-time-input bg-white p-2 border border-gray-300 rounded-md w-full" value="${dayData.from}" ${dayData.is24Hours ? 'disabled' : ''}>
                                    <span>to</span>
                                    <input type="time" class="to-time-input bg-white p-2 border border-gray-300 rounded-md w-full" value="${dayData.to}" ${dayData.is24Hours ? 'disabled' : ''}>
                                    <label class="flex items-center text-sm whitespace-nowrap"><input type="checkbox" class="h-4 w-4 rounded border-gray-300 mr-1 twenty-four-hour-checkbox" ${dayData.is24Hours ? 'checked' : ''}>24 hours</label>
                                </div>
                                <div class="closed-text md:col-span-3 text-gray-500 ${dayData.isOpen ? 'hidden' : ''}">Closed</div>`;
                hoursContainer.appendChild(dayRow);
            });
            hoursContainer.addEventListener('change', (e) => {
                const row = e.target.closest('[data-day]');
                if (!row) return;
                if (e.target.classList.contains('day-open-checkbox')) {
                    row.querySelector('.time-inputs').classList.toggle('hidden', !e.target.checked);
                    row.querySelector('.closed-text').classList.toggle('hidden', e.target.checked);
                }
                if (e.target.classList.contains('twenty-four-hour-checkbox')) {
                    row.querySelector('.from-time-input').disabled = e.target.checked;
                    row.querySelector('.to-time-input').disabled = e.target.checked;
                }
            });
            document.getElementById('save-location-btn').addEventListener('click', saveLocationSection);

            FontAwesome.dom.i2svg(); // Manually render icons

        }
        async function saveLocationSection() {
            const saveBtn = document.getElementById('save-location-btn');
            saveBtn.textContent = 'Saving...';
            saveBtn.disabled = true;
            const street = document.getElementById('address-street').value.trim();
            const city = document.getElementById('address-city').value.trim();
            const state = document.getElementById('address-state').value.trim();
            const zip = document.getElementById('address-zip').value.trim();
            const fullAddress = [street, city, state, zip].filter(Boolean).join(', ');
            const hoursData = {};
            document.querySelectorAll('#hours-inputs [data-day]').forEach(row => {
                const day = row.dataset.day;
                const isOpen = row.querySelector('.day-open-checkbox').checked;
                const is24Hours = row.querySelector('.twenty-four-hour-checkbox').checked;
                const from = row.querySelector('.from-time-input').value;
                const to = row.querySelector('.to-time-input').value;
                hoursData[day] = { isOpen, is24Hours, from, to };
            });
            const updatedData = {
                address: street, city: city, state: state, zip_code: zip, hours_data: hoursData,
            };
            if (fullAddress && fullAddress !== [currentBusinessData.address, currentBusinessData.city, currentBusinessData.state, currentBusinessData.zip_code].filter(Boolean).join(', ')) {
                try {
                    const geocodeUrl = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(fullAddress)}&key=AIzaSyCs_qWUlsuNcc_5FPd41AhjwD4NyLz-I4k`;
                    const res = await fetch(geocodeUrl);
                    const data = await res.json();
                    if (data.status === 'OK' && data.results.length > 0) {
                        updatedData.latitude = data.results[0].geometry.location.lat;
                        updatedData.longitude = data.results[0].geometry.location.lng;
                    } else {
                        alert(`Could not find that address on the map. Error: ${data.status}`);
                        saveBtn.textContent = 'Save Changes'; saveBtn.disabled = false; return;
                    }
                } catch (err) {
                    alert('An error occurred while trying to geocode the address.');
                    saveBtn.textContent = 'Save Changes'; saveBtn.disabled = false; return;
                }
            }
            const { data, error } = await supabaseClient.from('businesses').update(updatedData).eq('id', currentBusinessData.id).select().single();
            if (error) {
                console.error('Error updating location section:', error);
                alert('Error: Could not save changes.');
            } else {
                currentBusinessData = data;
                saveBtn.textContent = 'Saved!';
                setTimeout(() => { saveBtn.textContent = 'Save Changes'; }, 2000);
            }
            saveBtn.disabled = false;

        }

        // --- CONTACT SECTION ---
        function renderContactSection() {
            const container = document.getElementById('edit-content');
            container.innerHTML = `
                            <h2 class="text-2xl font-bold mb-2">Contact & Social</h2>
                            <p class="text-gray-600 mb-6">Provide ways for customers to reach you and follow you online.</p>
                            <div class="space-y-6">
                                <div class="space-y-4 bg-gray-50 p-6 rounded-lg">
                                    <h3 class="font-bold text-lg text-gray-800">Contact Information</h3>
                                    <div>
                                        <label for="contact-phone" class="block text-sm font-medium text-gray-700">Public Phone Number</label>
                                        <input type="tel" id="contact-phone" class="mt-1 block w-full p-3 border border-gray-300 rounded-md" value="${currentBusinessData.phone || ''}">
                                    </div>
                                    <div>
                                        <label for="contact-email" class="block text-sm font-medium text-gray-700">Public Email Address</label>
                                        <input type="email" id="contact-email" class="mt-1 block w-full p-3 border border-gray-300 rounded-md" value="${currentBusinessData.email || ''}">
                                    </div>
                                    <div>
                                        <label for="contact-website" class="block text-sm font-medium text-gray-700">Website URL</label>
                                        <input type="url" id="contact-website" placeholder="https://example.com" class="mt-1 block w-full p-3 border border-gray-300 rounded-md" value="${currentBusinessData.website || ''}">
                                    </div>
                                </div>
                                <div class="space-y-4 bg-gray-50 p-6 rounded-lg">
                                    <h3 class="font-bold text-lg text-gray-800">Social Media</h3>
                                    <div id="social-links-container" class="space-y-3"></div>
                                </div>
                            </div>
                            <div class="flex justify-end mt-8">
                                <button id="save-contact-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 disabled:bg-gray-400">Save Changes</button>
                            </div>
                        `;
            const socialContainer = document.getElementById('social-links-container');
            const socialPlatforms = ['Facebook', 'Instagram', 'X (Twitter)', 'TikTok', 'YouTube', 'LinkedIn'];
            const socialData = currentBusinessData.social_links || {};
            socialPlatforms.forEach(platform => {
                const key = platform.split(' ')[0].toLowerCase().replace(/[^a-z]/g, '');
                const url = socialData[key] || '';
                const row = document.createElement('div');
                row.className = 'flex items-center gap-3';
                row.innerHTML = `
                        <label for="social-${key}" class="w-28 flex-shrink-0 text-sm font-medium text-gray-700">${platform}</label>
                        <input type="url" id="social-${key}" data-key="${key}" class="social-link-input flex-grow p-2 border border-gray-300 rounded-md" placeholder="Enter full URL..." value="${url}">
                    `;
                socialContainer.appendChild(row);
            });
            document.getElementById('save-contact-btn').addEventListener('click', saveContactSection);

            FontAwesome.dom.i2svg(); // Manually render icons

        }
        async function saveContactSection() {
                const saveBtn = document.getElementById('save-contact-btn');
                saveBtn.textContent = 'Saving...';
                saveBtn.disabled = true;
                const socialLinks = {};
                document.querySelectorAll('.social-link-input').forEach(input => {
                    const key = input.dataset.key;
                    const url = input.value.trim();
                    if (url) socialLinks[key] = url;
                });
                const updatedData = {
                    phone: document.getElementById('contact-phone').value.trim(),
                    email: document.getElementById('contact-email').value.trim(),
                    website: document.getElementById('contact-website').value.trim(),
                    social_links: socialLinks,
                };
                const { data, error } = await supabaseClient.from('businesses').update(updatedData).eq('id', currentBusinessData.id).select().single();
                if (error) {
                    console.error('Error updating contact section:', error);
                    alert('Error: Could not save changes.');
                } else {
                    currentBusinessData = data;
                    saveBtn.textContent = 'Saved!';
                    setTimeout(() => { saveBtn.textContent = 'Save Changes'; }, 2000);
                }
                saveBtn.disabled = false;

            }

        // --- OFFERS SECTION ---
        async function renderOffersSection() {
                const container = document.getElementById('edit-content');
                container.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold mb-2">Manage Offers</h2>
                    <p class="text-gray-600">Create and manage special offers to attract customers.</p>
                </div>
                <button id="add-offer-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">
                    <i class="fas fa-plus mr-2"></i> Add New Offer
                </button>
                </div>
                <div id="offers-list-container" class="space-y-4">
                <p>Loading offers...</p>
                </div>
            `;

                // 1) Fetch offers FIRST
                const { data: offers, error } = await supabaseClient
                    .from('offers')
                    .select('*')
                    .eq('business_id', currentBusinessData.id)
                    .order('created_at', { ascending: false });

                if (error) {
                    document.getElementById('offers-list-container').innerHTML =
                        '<p class="text-red-500">Could not load offers.</p>';
                    return;
                }

                // 2) Plan limit (normalized)
                const { data: profileRow } = await supabaseClient
                    .from('profiles')
                    .select('membership_level')
                    .eq('id', currentBusinessData.owner_id)
                    .single();
                const OFFER_LIMITS = { free: 0, essentials: 3, pro: 999 };
                const membership = (profileRow?.membership_level || 'free').toString().trim().toLowerCase();
                const offerLimit = OFFER_LIMITS[membership] ?? 0;
                window.__offerLimitReached = (offers?.length || 0) >= offerLimit;

                // 3) Wire the "Add New Offer" button (and reflect limit)
                const addOfferBtn = document.getElementById('add-offer-btn');
                if (addOfferBtn) {
                    const btn = addOfferBtn.cloneNode(true);
                    addOfferBtn.replaceWith(btn);
                    btn.disabled = window.__offerLimitReached;
                    btn.classList.toggle('opacity-50', window.__offerLimitReached);
                    btn.classList.toggle('cursor-not-allowed', window.__offerLimitReached);
                    btn.title = window.__offerLimitReached ?
                        `You’ve reached your offer limit (${offerLimit}).` :
                        '';
                    btn.addEventListener('click', () => {
                        if (window.__offerLimitReached) {
                            alert(`Offer limit reached for your plan (${offerLimit}). Delete one or upgrade.`);
                            return;
                        }
                        const modal = document.getElementById('offer-modal');
                        if (!modal) return;

                        document.getElementById('offer-modal-title').textContent = 'Add New Offer';
                        document.getElementById('offer-id-input').value = '';
                        document.getElementById('offer-title').value = '';
                        document.getElementById('offer-description').value = '';
                        document.getElementById('offer-pin').value = '';
                        document.getElementById('offer-limit').value = '';
                        const firstTime = document.getElementById('offer-first-time');
                        if (firstTime) firstTime.checked = false;
                        const expires = document.getElementById('offer-expires-at');
                        if (expires) expires.value = '';

                        modal.classList.remove('hidden');
                    });
                }

                // 4) Render list
                const list = document.getElementById('offers-list-container');
                list.innerHTML = '';
                if (!offers || offers.length === 0) {
                    list.innerHTML = '<p class="text-gray-500 text-center py-8">No offers yet. Click "Add New Offer" to get started!</p>';
                } else {
                    offers.forEach(offer => {
                        const card = document.createElement('div');
                        card.className = 'bg-gray-50 p-4 rounded-lg shadow-sm flex justify-between items-center';
                        card.innerHTML = `
                        <div>
                            <h4 class="font-bold text-lg">${offer.title || ''}</h4>
                            <p class="text-sm text-gray-600">${offer.description || ''}</p>
                            <p class="text-xs text-gray-500 mt-2">
                                PIN: ${offer.redemption_pin || '—'} | Limit: ${offer.claim_limit ?? 'None'}
                            </p>
                        </div>
                        <div>
                            <button class="edit-offer-btn text-blue-600 hover:text-blue-800 mr-4" data-offer-id="${offer.id}">Edit</button>
                            <button class="delete-offer-btn text-red-600 hover:text-red-800" data-offer-id="${offer.id}">Delete</button>
                        </div>
                    `;
                        list.appendChild(card);
                    });
                }

                // 5) Make the modal buttons (X / Save) work
                setupOfferModal();

                // --- NEW CODE: ADD EVENT LISTENERS FOR EDIT AND DELETE ---
                const offersListContainer = document.getElementById('offers-list-container');
                offersListContainer.addEventListener('click', async (e) => {
                    const modal = document.getElementById('offer-modal');

                    // --- EDIT BUTTON LOGIC ---
                    if (e.target.classList.contains('edit-offer-btn')) {
                        const offerId = e.target.dataset.offerId;
                        const offerToEdit = offers.find(o => String(o.id) === offerId);

                        if (offerToEdit && modal) {
                            document.getElementById('offer-modal-title').textContent = 'Edit Offer';
                            document.getElementById('offer-id-input').value = offerToEdit.id;
                            document.getElementById('offer-title').value = offerToEdit.title || '';
                            document.getElementById('offer-description').value = offerToEdit.description || '';
                            document.getElementById('offer-pin').value = offerToEdit.redemption_pin || '';
                            document.getElementById('offer-limit').value = offerToEdit.claim_limit || '';
                            document.getElementById('offer-first-time').checked = offerToEdit.is_first_time_only;
                            // Format the date for the date input field
                            document.getElementById('offer-expires-at').value = offerToEdit.expires_at ? offerToEdit.expires_at.split('T')[0] : '';

                            modal.classList.remove('hidden');
                        }
                    }

                    // --- DELETE BUTTON LOGIC ---
                    if (e.target.classList.contains('delete-offer-btn')) {
                        const offerId = e.target.dataset.offerId;
                        if (confirm('Are you sure you want to delete this offer? This cannot be undone.')) {
                            const { error: deleteError } = await supabaseClient
                                .from('offers')
                                .delete()
                                .eq('id', offerId);

                            if (deleteError) {
                                alert('Error: Could not delete the offer. Please try again.');
                                console.error('Delete error:', deleteError);
                            } else {
                                alert('Offer deleted successfully.');
                                renderOffersSection(); // Re-render the list to show the change
                            }
                        }
                    }
                });
            }


        function setupOfferModal() {
                const modal = document.getElementById('offer-modal');
                if (!modal) return;

                // avoid re-binding overlay/escape on every render
                if (modal.dataset.wired === '1') return;
                modal.dataset.wired = '1';
                modal.setAttribute('tabindex', '-1'); // so Esc works when focused


                const closeX = document.getElementById('close-offer-modal-btn');
                const save = document.getElementById('save-offer-btn');

                // An array of buttons we need to re-wire
                const elementsToRebind = [closeX, save].filter(Boolean);

                elementsToRebind.forEach((el) => {
                    // Clone the element to remove any old event listeners
                    const freshElement = el.cloneNode(true);
                    el.replaceWith(freshElement);

                    // Add the correct listener based on the element's ID
                    if (freshElement.id === 'close-offer-modal-btn') {
                        freshElement.addEventListener('click', () => modal.classList.add('hidden'));
                    }

                    else if (freshElement.id === 'save-offer-btn') {
                        freshElement.addEventListener('click', async () => {
                            const originalText = freshElement.textContent;
                            freshElement.disabled = true;
                            freshElement.textContent = 'Saving…';

                            try {
                                // Call saveOffer directly, not from the window object
                                await saveOffer();
                                // The saveOffer function will close the modal and re-render on success
                            } catch (error) {
                                console.error("An error occurred during save:", error);
                                // On error, restore the button so the user can try again
                                freshElement.disabled = false;
                                freshElement.textContent = originalText;
                            }
                            // We don't need to restore the button on success, 
                            // because the whole section will be re-rendered.
                        });
                    }
                });

                // Click outside to close
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                }, { passive: true });

                // ESC key to close
                modal.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') modal.classList.add('hidden');
                });
            }

        async function saveOffer() {
                        const saveBtn = document.getElementById('save-offer-btn');
            saveBtn.textContent = 'Saving...';
            saveBtn.disabled = true;

            // --- Collect Data from Form ---
            const offerId = document.getElementById('offer-id-input').value;
            const title = document.getElementById('offer-title').value.trim();
            const description = document.getElementById('offer-description').value.trim();
            const redemption_pin = document.getElementById('offer-pin').value.trim();
            const claim_limit = document.getElementById('offer-limit').value;
            const is_first_time_only = document.getElementById('offer-first-time').checked;
            const expires_at = document.getElementById('offer-expires-at').value;

            // --- Basic Validation ---
            if (!title || !description || !redemption_pin) {
                alert('Please fill out the Title, Description, and Redemption PIN fields.');
                saveBtn.textContent = 'Save Offer';
                saveBtn.disabled = false;
                return;
            }

            // --- Prepare Data for Supabase ---
            const offerData = {
                business_id: currentBusinessData.id,
                title: title,
                description: description,
                redemption_pin: redemption_pin,
                claim_limit: claim_limit ? parseInt(claim_limit, 10) : null,
                is_first_time_only: is_first_time_only,
                expires_at: expires_at ? expires_at : null,
            };

            let error;

            // --- Determine if we are UPDATING or INSERTING ---
            if (offerId) {
                // We have an ID, so we are updating an existing offer
                const { error: updateError } = await supabaseClient
                    .from('offers')
                    .update(offerData)
                    .eq('id', offerId);
                error = updateError;
            } else {
                // Guard: re-check limit just before inserting (normalized)
                const { data: profileRow } = await supabaseClient
                    .from('profiles')
                    .select('membership_level')
                    .eq('id', currentBusinessData.owner_id)
                    .single();

                const OFFER_LIMITS = { free: 0, essentials: 3, pro: 999 };
                const membershipRaw = profileRow?.membership_level || 'free';
                const membership = membershipRaw.toString().trim().toLowerCase();
                const offerLimit = OFFER_LIMITS[membership] ?? 0;

                const { count, error: countErr } = await supabaseClient
                    .from('offers')
                    .select('id', { count: 'exact', head: true })
                    .eq('business_id', currentBusinessData.id);

                if (!countErr && (count ?? 0) >= offerLimit) {
                    alert(`Offer limit reached for your plan (${offerLimit}). Delete an offer or upgrade.`);
                    saveBtn.textContent = 'Save Offer';
                    saveBtn.disabled = false;
                    return;
                }


                // No ID, so we are inserting a new offer
                const { error: insertError } = await supabaseClient
                    .from('offers')
                    .insert([offerData]);
                error = insertError;
            }

            // --- Handle Response ---
            if (error) {
                console.error('Error saving offer:', error);
                alert('There was an error saving the offer. Please try again.');
            } else {
                alert('Offer saved successfully!');
                document.getElementById('offer-modal').classList.add('hidden'); // Close the modal
                renderOffersSection(); // Re-render the offers list to show the new/updated offer
            }

            saveBtn.textContent = 'Save Offer';
            saveBtn.disabled = false;

        }

        function closeOfferModal() {
                const modal = document.getElementById('offer-modal');
                if (modal) modal.classList.add('hidden');
            }

            
        // --- NEW & REBUILT CATEGORIES & TAGS SECTION ---
        async function renderCategoriesSection() {
                const container = document.getElementById('edit-content');
                container.innerHTML = `
                    <h2 class="text-2xl font-bold mb-2">Categories & Tags</h2>
                    <p class="text-gray-600 mb-6">Help customers find you by selecting all relevant categories and tags.</p>
                    <div id="tier-limit-info" class="p-3 bg-blue-100 text-blue-800 rounded-md mb-6 text-sm font-medium">Loading tier limits...</div>
                    
                    <div class="bg-gray-50 p-6 rounded-lg mb-8">
                        <h3 class="font-bold text-lg text-gray-800">Step 1: Choose Your Business Category</h3>
                        <p class="text-sm text-gray-500 mb-4">First, select the primary category that defines your business. Selections must be within the same main group (e.g., "Food & Drink").</p>
                        <div id="category-checklist-container" class="space-y-3">Loading...</div>
                    </div>

                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h3 class="font-bold text-lg text-gray-800">Step 2: Choose Your Tags</h3>
                        <p class="text-sm text-gray-500 mb-4">Now, select all the attributes and services that apply to your business. The options below will update based on the category you chose in Step 1.</p>
                        <div id="tags-checklist-container" class="space-y-4">Loading...</div>
                    </div>
                    
                    <div class="flex justify-end mt-8">
                        <button id="save-categories-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg">Save Changes</button>
                    </div>
                `;

                // The rest of the function that fetches and renders the data remains the same...
                const [catRes, tagRes, groupRes, profileRes] = await Promise.all([
                    supabaseClient.from('categories').select('*').order('name'),
                    supabaseClient.from('tags').select('*').order('name'),
                    supabaseClient.from('tag_groups').select('*').order('name'),
                    supabaseClient.from('profiles').select('membership_level').eq('id', currentBusinessData.owner_id).single()
                ]);

                const allCategories = catRes.data || [];
                const allTags = tagRes.data || [];
                const allGroups = groupRes.data || [];
                const membership = profileRes.data?.membership_level || 'free';

                const tierLimits = {
                    free: { categories: 1, tags: 5 },
                    Essentials: { categories: 3, tags: 15 },
                    Pro: { categories: 7, tags: 999 }
                };
                const limits = tierLimits[membership] || tierLimits.free;
                document.getElementById('tier-limit-info').textContent = `Your '${membership}' plan allows up to ${limits.categories} categories and ${limits.tags} tags.`;

                // Render Categories
                const catContainer = document.getElementById('category-checklist-container');
                catContainer.innerHTML = '';
                const mainCategories = allCategories.filter(c => c.parent_id === null);
                mainCategories.forEach(mainCat => {
                    let html = `<div class="font-semibold text-gray-900">${mainCat.name}</div><div class="grid grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-2 pl-4">`;
                    const subCats = allCategories.filter(c => String(c.parent_id) === String(mainCat.id));
                    subCats.forEach(subCat => {
                        const isChecked = currentBusinessData.business_categories.some(bc => String(bc.category_id) === String(subCat.id));
                        html += `<label class="flex items-center font-normal text-gray-700"><input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 category-checkbox" value="${subCat.id}" data-parent-id="${mainCat.id}" ${isChecked ? 'checked' : ''}><span class="ml-2">${subCat.name}</span></label>`;
                    });
                    html += `</div>`;
                    catContainer.innerHTML += html;
                });

                // Render Tags
                const tagContainer = document.getElementById('tags-checklist-container');
                tagContainer.innerHTML = '';
                allGroups.forEach(group => {
                    let html = `<div class="font-semibold text-gray-900">${group.name}</div><div class="grid grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-2 pl-4">`;
                    const tagsInGroup = allTags.filter(t => t.group_id === group.id);
                    tagsInGroup.forEach(tag => {
                        const isChecked = currentBusinessData.business_tags.some(bt => bt.tag_id === tag.id);
                        html += `<label class="flex items-center font-normal text-gray-700"><input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 tag-checkbox" value="${tag.id}" ${isChecked ? 'checked' : ''}><span class="ml-2">${tag.name}</span></label>`;
                    });
                    html += `</div>`;
                    tagContainer.innerHTML += html;
                });

                // Add event listeners
                document.getElementById('save-categories-btn').addEventListener('click', () => saveCategoriesAndTags(limits));
                catContainer.addEventListener('change', updateVisibleTags);
                updateVisibleTags(); // Run once on load
            }

        window.renderCategoriesSection = renderCategoriesSection;


        async function saveCategoriesAndTags(limits) {
            const saveBtn = document.getElementById('save-categories-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            const selectedCategoryCheckboxes = Array.from(document.querySelectorAll('.category-checkbox:checked'));
            const selectedCategoryIds = selectedCategoryCheckboxes.map(cb => cb.value);
            const selectedTagIds = Array.from(document.querySelectorAll('.tag-checkbox:checked')).map(cb => cb.value);

            // --- VALIDATION: "Stay in Your Lane" ---
            const parentIds = new Set(selectedCategoryCheckboxes.map(cb => cb.dataset.parentId));
            if (parentIds.size > 1) {
                alert("Please select categories from only one main business type (e.g., 'Food & Drink').");
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
                return;
            }

            // --- VALIDATION: Tier Limits ---
            if (selectedCategoryIds.length > limits.categories) {
                alert(`Your plan limits you to ${limits.categories} categories. You have selected ${selectedCategoryIds.length}.`);
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
                return;
            }
            if (selectedTagIds.length > limits.tags) {
                alert(`Your plan limits you to ${limits.tags} tags. You have selected ${selectedTagIds.length}.`);
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
                return;
            }

            try {
                // Sync Categories
                await supabaseClient.from('business_categories').delete().eq('business_id', currentBusinessData.id);
                if (selectedCategoryIds.length > 0) {
                    const newCategoryLinks = selectedCategoryIds.map(id => ({ business_id: currentBusinessData.id, category_id: id }));
                    await supabaseClient.from('business_categories').insert(newCategoryLinks);
                }

                // Sync Tags
                await supabaseClient.from('business_tags').delete().eq('business_id', currentBusinessData.id);
                if (selectedTagIds.length > 0) {
                    const newTagLinks = selectedTagIds.map(id => ({ business_id: currentBusinessData.id, tag_id: id }));
                    await supabaseClient.from('business_tags').insert(newTagLinks);
                }

                // Refresh local data
                const { data: updatedBusiness } = await supabaseClient.from('businesses').select('*, business_categories(category_id), business_tags(tag_id)').eq('id', currentBusinessData.id).single();
                currentBusinessData = updatedBusiness;

                showToast('Categories and tags saved!', 'success');
            } catch (error) {
                showToast('Error saving changes: ' + error.message, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
            }
        }

        async function updateVisibleTags() {
                const categoryCheckboxes = document.querySelectorAll('.category-checkbox:checked');
                const selectedCategoryIds = Array.from(categoryCheckboxes).map(cb => cb.value);

                // Fetch all tags that belong to a "universal" group
                const { data: universalGroups, error: groupError } = await supabaseClient.from('tag_groups').select('id').eq('is_universal', true);
                if (groupError) {
                    console.error("Error fetching universal groups:", groupError);
                    return;
                }
                const universalGroupIds = universalGroups.map(g => g.id);

                const { data: universalTags, error: uTagError } = await supabaseClient.from('tags').select('id').in('group_id', universalGroupIds);
                if (uTagError) {
                    console.error("Error fetching universal tags:", uTagError);
                    return;
                }

                const visibleTagIds = new Set(universalTags.map(t => t.id));

                // If categories are selected, fetch their specific tags as well
                if (selectedCategoryIds.length > 0) {
                    const { data: specificTags, error: sTagError } = await supabaseClient.from('category_tags').select('tag_id').in('category_id', selectedCategoryIds);
                    if (sTagError) {
                        console.error("Error fetching specific tags:", sTagError);
                        return;
                    }
                    specificTags.forEach(t => visibleTagIds.add(t.tag_id));
                }

                // Now, show or hide all tag checkboxes based on our final list
                const allTagCheckboxes = document.querySelectorAll('.tag-checkbox');
                allTagCheckboxes.forEach(checkbox => {
                    const tagId = parseInt(checkbox.value, 10);
                    const wrapper = checkbox.parentElement; // The <label> tag
                    if (visibleTagIds.has(tagId)) {
                        wrapper.style.display = 'flex';
                    } else {
                        wrapper.style.display = 'none';
                    }
                });
            }
        
        

            window.renderCategoriesSection = renderCategoriesSection;
                window.renderOffersSection = renderOffersSection;


    </script>


</body>

</html>